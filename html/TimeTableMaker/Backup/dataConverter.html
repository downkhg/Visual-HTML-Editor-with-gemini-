<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ì‹œê°„í‘œ Excel to JSON ë³€í™˜ê¸° (ìµœì¢… ì™„ì„±íŒ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #1c1e21;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 15px;
            margin-top: 0;
        }

        .instruction {
            background: #e8f0fe;
            padding: 15px;
            border-left: 5px solid #1a73e8;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .upload-section {
            margin: 20px 0;
            padding: 40px;
            border: 3px dashed #1a73e8;
            border-radius: 12px;
            text-align: center;
            transition: background 0.3s;
        }

            .upload-section:hover {
                background: #f8fbff;
            }

        #fileInput {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

            button:hover {
                background-color: #1557b0;
            }

            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }

        #output {
            width: 100%;
            height: 500px;
            margin-top: 30px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
        }

        .status {
            margin-top: 15px;
            font-weight: bold;
            color: #5f6368;
        }

        .success {
            color: #1e8e3e;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“… ê°•ì˜ì‹œê°„í‘œ JSON ë³€í™˜ê¸° (ìµœì¢… ì™„ì„±íŒ)</h1>
        <div class="instruction">
            <strong>ì‹œìŠ¤í…œ ë¦¬íŒ©í† ë§ ë° ë°ì´í„° ì•ˆì •í™” ì™„ë£Œ:</strong><br>
            - ğŸ—ï¸ <b>ë¹Œë” íŒ¨í„´ ë„ì…:</b> ê°•ì˜ ë°ì´í„° ì¡°ë¦½ì„ ì „ë‹´í•˜ì—¬ ë¬´ê²°ì„± í™•ë³´.<br>
            - ğŸ”„ <b>FSM(ìƒíƒœ ê¸°ê³„) íŒŒì„œ:</b> ì…€ íƒìƒ‰ ë¡œì§ì„ 'ìƒíƒœ' ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¦¬.<br>
            - â±ï¸ <b>ì‹œê°„ ë³€í™˜ ì •ë°€í™”:</b> Excel ê³ ìœ  ì‹œê°„(Decimal) ê°’ì„ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ 24ì‹œê°„ì œ ê³„ì‚°í•˜ì—¬ ì˜¤í›„ ì‹œê°„ ì™œê³¡ ë° Type Error ì™„ë²½ í•´ê²°.<br>
            - ğŸ›¡ï¸ <b>ì •ê·œì‹ ì˜ˆì™¸ ì²˜ë¦¬ ë³´ì™„:</b> ìˆ«ì 2ìë¦¬ ê°•ì‚¬ëª…(ì˜ˆ: ê¹€ì§€ì›14) í—ˆìš© ë° 4ê¸€ì ê³¼ëª©ëª…(ì˜ˆ: ê²Œì„ì›í™”) ëˆ„ë½ ë°©ì§€ ë¡œì§ ì ìš©.
        </div>

        <div class="upload-section">
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <div class="status" id="status">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>

        <div class="btn-group">
            <button id="copyJson" disabled>JSON ë³µì‚¬</button>
            <button id="downloadJson" disabled>JSON ë‹¤ìš´ë¡œë“œ</button>
            <button id="downloadJs" disabled>data.js ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="output">// ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <script>
        const IGNORE_KEYWORDS = ["ì „ì²´ì¶œì„ìœ¨", "ë‹¹ì¼ì¶œì„ìœ¨", "ì •ì› :", "ê°•ì‚¬ :", "ë°°ì •:", "ê°œ:", "ì¢…:", "ìˆ˜ì—…ì—†ìŒ", "ì„¤ì—°íœ´", "íœ´ê°•", "ê°œê°•ì—°ê¸°"];
        const DAY_PATTERNS = ["ì›”~ê¸ˆ", "ì›”/ìˆ˜/ê¸ˆ", "í™”/ëª©", "ê²©ì¼", "ì›”ìˆ˜ê¸ˆ", "í™”ëª©", "ì›”ìˆ˜ê¸ˆì›”ìˆ˜", "í™”ëª©í™”ëª©ê¸ˆ"];

        // ==========================================
        // 1. ê°•ì˜ ê°ì²´ ì¡°ë¦½ê¸° (Builder Pattern)
        // ==========================================
        class LectureBuilder {
            constructor(id, subject, room, timeStr, subRoom) {
                this.id = id;
                this.subject = subject;
                this.room = room;
                this.subRoom = subRoom;

                // ì—ëŸ¬ ë°©ì–´: ì–´ë–¤ ê°’ì´ ë“¤ì–´ì™€ë„ ë¬´ì¡°ê±´ ë¬¸ìì—´ ì²˜ë¦¬ í›„ ë¶„ë¦¬
                //const timeParts = String(timeStr || "00:00").split(':');
                const timeParts = String(timeStr || "00").split(':');
                const h = parseInt(timeParts[0], 10) || 0;
                //const m = parseInt(timeParts[1], 10) || 0;

                //this.startTimeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                this.startH = h;

                // ë„ë©”ì¸ ê·œì¹™ì— ë”°ë¥¸ ìœ ì—°í•œ ìˆ˜ì—… ì‹œê°„(Duration)
                let durationH = 2; // ê¸°ë³¸ 2ì‹œê°„
                if (subject.includes('êµ­]') || subject.includes('ì „ë¬¸ê°€ì–‘ì„±')) {
                    durationH = 9; // êµ­ë¹„ ì¢…ì¼ë°˜
                } else if (subject.includes('ì£¼ë§')) {
                    durationH = 4; // ì£¼ë§ë°˜
                }

                this.endH = h + durationH;
                //this.endTimeStr = `${String(endH).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                this.instructor = "";
                this.days = "ì›”~ê¸ˆ";
                this.startDate = "";
                this.endDate = "";
            }

            parseAttribute(val) {
                if (!val) return;

                // [ë³´ì™„] ê°•ì‚¬ëª… ì •ê·œì‹ ìˆ˜ì • (\d* ì ìš© ë° ê³¼ëª©ëª… ì˜¤ì¸ ë°©ì§€)
                if (val.includes('ê°•ì‚¬ :')) {
                    this.instructor = val.replace('ê°•ì‚¬ :', '').trim();
                } else if (/^[ê°€-í£]{2,4}\d*$/.test(val) && !this.instructor) {
                    // í˜¹ì‹œ ëª¨ë¥¼ 4ê¸€ì ê³¼ëª©ëª… ë®ì–´ì“°ê¸° ë°©ì§€
                    if (!(val.includes('ê²Œì„') || val.includes('ì›¹íˆ°') || val.includes('ì›í™”') || val.includes('ì½˜í‹°'))) {
                        this.instructor = val.trim();
                    }
                }

                if (DAY_PATTERNS.some(d => val.includes(d))) {
                    this.days = val.trim();
                }

                const dateMatch = val.match(/(\d{4}-\d{2}-\d{2})/);
                if (dateMatch) {
                    if (val.includes('ê°œ:')) this.startDate = dateMatch[1].substring(5);
                    if (val.includes('ì¢…:')) this.endDate = dateMatch[1].substring(5);
                }
            }

            _getCategory(subject) {
                const s = subject.toLowerCase();
                if (s.includes('ì›¹íˆ°')) return 'webtoon';
                if (s.includes('ì´ëª¨í‹°ì½˜')) return 'emo';
                if (s.includes('í”„ë¡œê·¸ë˜ë°')) return 'prog-adv';
                if (s.includes('ê¸°íš')) return 'plan-adv';
                if (s.includes('ui') || s.includes('ux')) return 'ui';
                if (s.includes('ê·¸ë˜í”½')) return 'graphic';
                if (s.includes('ì›í™”') || s.includes('ìºë¦­í„°')) return 'art-adv';
                if (s.includes('ì•„íŠ¸ì›') || s.includes('ë“œë¡œì‰')) return 'art-basic';
                if (s.includes('êµ­]') || s.includes('k-digital') || s.includes('ì „ë¬¸ê°€ì–‘ì„±')) return 'kdigital';
                if (s.includes('í¬í´') || s.includes('í¬íŠ¸í´ë¦¬ì˜¤')) return 'port';
                return 'art-basic';
            }

            _calculateWeekType() {
                let weekType = "ALL";
                const dayStr = this.days.replace(/\s/g, "");

                if (dayStr.includes("í™”ëª©") || dayStr.includes("í™”/ëª©")) weekType = "A";
                else if (dayStr.includes("ì›”ìˆ˜ê¸ˆ") || dayStr.includes("ì›”/ìˆ˜/ê¸ˆ")) weekType = "B";

                if (this.subject.includes("ê²©ì¼") || this.days.includes("ê²©ì¼") || weekType !== "ALL") {
                    if (weekType === "ALL") {
                        if (this.subRoom.endsWith("-2")) weekType = "B";
                        else if (this.subRoom.endsWith("-1")) weekType = "A";
                    }
                }
                if (dayStr === "ì›”~ê¸ˆ") weekType = "ALL";
                return weekType;
            }

            build() {
                const finalDateInfo = (this.startDate && this.endDate) ? `${this.startDate} ~ ${this.endDate}` : "";

                // ê°•ì‚¬ëª… ë’¤ì— ë¶™ì€ ë²ˆí˜¸(ì˜ˆ: ê¹€ì§€ì›14 -> ê¹€ì§€ì›) ì œê±° ì •ì œ
                const cleanInstructor = this.instructor.replace(/\d+$/, '').trim();

                return {
                    id: this.id,
                    subject: this.subject,
                    instructor: cleanInstructor,
                    room: this.room,
                    //startTime: this.startTimeStr,
                    //endTime: this.endTimeStr,
                    startH: this.startH,
                    endH: this.endH,
                    days: this.days,
                    dateInfo: finalDateInfo,
                    category: this._getCategory(this.subject),
                    weekType: this._calculateWeekType(),
                    isBadge: "",
                    fontSize: 14,
                    opacity: 100
                };
            }
        }

        // ==========================================
        // 2. FSM ê¸°ë°˜ ì‹œê°„í‘œ íŒŒì„œ (State Pattern)
        // ==========================================
        class TimetableParser {
            constructor(df) {
                this.df = df;
                this.lectures = [];
                this.lectureId = 1;
                this.roomMap = {};
                this.subRoomMap = {};
                this.timeMap = {};
            }

            parse() {
                this._buildAxes();
                const maxCols = this.df[0] ? this.df[0].length : 0;
                for (let c = 1; c < maxCols; c++) {
                    if (!this.roomMap[c]) continue;
                    this._parseColumn(c);
                }
                return this.lectures;
            }

            _buildAxes() {
                let currentRoom = "";
                const firstRow = this.df[0] || [];
                const secondRow = this.df[1] || [];

                for (let c = 1; c < firstRow.length; c++) {
                    if (firstRow[c] && String(firstRow[c]).trim()) currentRoom = String(firstRow[c]).trim();
                    this.roomMap[c] = currentRoom;
                    this.subRoomMap[c] = String(secondRow[c] || "").trim();
                }

                let lastTime = "00:00";
                for (let r = 0; r < this.df.length; r++) {
                    const tVal = this.df[r][0];

                    if (tVal !== undefined && tVal !== null && tVal !== "") {
                        if (typeof tVal === 'number') {
                            // ì—‘ì…€ì˜ ì‹œê°„ ë°ì´í„°(Decimal)ë¥¼ 24ì‹œê°„ì œ HH:mm í˜•íƒœë¡œ ì§ì ‘ ê³„ì‚°
                            const totalMinutes = Math.round(tVal * 24 * 60);
                            const h = Math.floor(totalMinutes / 60);
                            const m = totalMinutes % 60;
                            lastTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        } else if (String(tVal).includes(':')) {
                            const parts = String(tVal).split(':');
                            const h = parseInt(parts[0], 10) || 0;
                            const m = parseInt(parts[1], 10) || 0;
                            lastTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        }
                    }
                    this.timeMap[r] = lastTime;
                }
            }

            _isSubject(val) {
                if (!val) return false;
                const s = String(val).trim();
                if (s === "" || s === "undefined" || s === "null") return false;
                if (IGNORE_KEYWORDS.some(k => s.includes(k))) return false;
                if (DAY_PATTERNS.some(k => s === k)) return false;

                // [ë³´ì™„] \d? ë¥¼ \d* ë¡œ ë³€ê²½í•˜ì—¬ 14, 20 ê°™ì€ ë‘ ìë¦¬ ìˆ«ì ê°•ì‚¬ëª… í•„í„°ë§ í—ˆìš©
                if (/^[ê°€-í£]{2,4}\d*$/.test(s)) {
                    // ë‹¨, 4ê¸€ì ê³¼ëª©ëª…ì´ ê°•ì‚¬ë¡œ ì˜¤ì¸ë˜ì–´ ëˆ„ë½ë˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•œ ë³´í˜¸ë§‰
                    if (s.includes('ê²Œì„') || s.includes('ì›¹íˆ°') || s.includes('ì›í™”') || s.includes('ì½˜í‹°')) {
                        return true; // ê³¼ëª©ëª…ìœ¼ë¡œ ì¸ì •
                    }
                    return false; // ê·¸ ì™¸ì—ëŠ” ê°•ì‚¬ëª…ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ê³¼ëª© íƒìƒ‰ íŒ¨ìŠ¤
                }
                return true;
            }

            _parseColumn(c) {
                let state = 'IDLE';
                let currentBuilder = null;
                let lookaheadCount = 0;

                for (let r = 3; r < this.df.length; r++) {
                    const val = this.df[r][c];
                    const strVal = String(val || "").trim();

                    if (state === 'IDLE') {
                        if (this._isSubject(strVal)) {
                            // ì‹œê°„ ë¬¸ìì—´(ì˜ˆ: "18:30")ì„ Builderì— ì§ì ‘ ì „ë‹¬
                            const timeStr = String(this.timeMap[r] || "00:00");
                            currentBuilder = new LectureBuilder(this.lectureId++, strVal, this.roomMap[c], timeStr, this.subRoomMap[c]);
                            state = 'READING';
                            lookaheadCount = 0;
                        }
                    }
                    else if (state === 'READING') {
                        if (this._isSubject(strVal)) {
                            this.lectures.push(currentBuilder.build());

                            // ì‹œê°„ ë¬¸ìì—´ í†µì¼ ë° ì „ë‹¬
                            const timeStr = String(this.timeMap[r] || "00:00");
                            currentBuilder = new LectureBuilder(this.lectureId++, strVal, this.roomMap[c], timeStr, this.subRoomMap[c]);
                            lookaheadCount = 0;
                            continue;
                        }

                        if (lookaheadCount > 15) {
                            this.lectures.push(currentBuilder.build());
                            state = 'IDLE';
                            currentBuilder = null;
                            continue;
                        }

                        if (strVal) {
                            currentBuilder.parseAttribute(strVal);
                        }
                        lookaheadCount++;
                    }
                }

                if (currentBuilder) {
                    this.lectures.push(currentBuilder.build());
                }
            }
        }

        // ==========================================
        // 3. UI ë° ì´ë²¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬
        // ==========================================
        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const downloadJsonBtn = document.getElementById('downloadJson');
        const downloadJsBtn = document.getElementById('downloadJs');
        // âœ… ìƒˆë¡œ ì¶”ê°€: ë³µì‚¬ ë²„íŠ¼ DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const copyJsonBtn = document.getElementById('copyJson');

        let resultData = null;

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "íŒŒì¼ì„ ì½ê³  ë³€í™˜í•˜ëŠ” ì¤‘...";
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                // raw: false ì˜µì…˜ì„ ì œê±°í•˜ì—¬ ì—‘ì…€ì˜ ìˆ«ì í¬ë§·íŒ…(ì‹œê°„ ê°’)ì„ ì†ì‹¤ ì—†ì´ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                try {
                    const parser = new TimetableParser(rows);
                    resultData = parser.parse();

                    output.innerText = JSON.stringify(resultData, null, 2);
                    status.innerHTML = `<span class="success">ì„±ê³µ! ì´ ${resultData.length}ê°œì˜ ê°•ì˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.</span>`;

                    // âœ… ìƒˆë¡œ ì¶”ê°€: ë³€í™˜ ì™„ë£Œ ì‹œ ë³µì‚¬ ë²„íŠ¼ í™œì„±í™”
                    copyJsonBtn.disabled = false;
                    downloadJsonBtn.disabled = false;
                    downloadJsBtn.disabled = false;
                } catch (err) {
                    console.error(err);
                    status.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
                    output.innerText = err.stack;
                }
            };

            reader.readAsArrayBuffer(file);
        });

        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }


        downloadJsonBtn.onclick = () => downloadFile(JSON.stringify(resultData, null, 2), 'data.json', 'application/json');
        downloadJsBtn.onclick = () => downloadFile("const LECTURE_DATA = " + JSON.stringify(resultData, null, 2) + ";", 'data.js', 'text/javascript');

        // âœ… ìƒˆë¡œ ì¶”ê°€: í´ë¦½ë³´ë“œ ë³µì‚¬ ì´ë²¤íŠ¸
        copyJsonBtn.onclick = async () => {
            try {
                const jsonString = JSON.stringify(resultData, null, 2);
                await navigator.clipboard.writeText(jsonString); // í´ë¦½ë³´ë“œ API ì‚¬ìš©

                // ì§ê´€ì ì¸ ìƒíƒœ í”¼ë“œë°± (2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬)
                const originalText = copyJsonBtn.innerText;
                copyJsonBtn.innerText = "âœ… ë³µì‚¬ ì™„ë£Œ!";
                copyJsonBtn.style.backgroundColor = "#1e8e3e"; // ì´ˆë¡ìƒ‰(ì„±ê³µ ìƒ‰ìƒ)ìœ¼ë¡œ ì„ì‹œ ë³€ê²½

                setTimeout(() => {
                    copyJsonBtn.innerText = originalText;
                    copyJsonBtn.style.backgroundColor = ""; // ì›ë˜ CSS ìŠ¤íƒ€ì¼ë¡œ ë³µêµ¬
                }, 2000);

            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

    </script>
</body>
</html>