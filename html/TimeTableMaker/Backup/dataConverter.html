<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ì‹œê°„í‘œ Excel to JSON ë³€í™˜ê¸° (ì•„í‚¤í…ì²˜ ê°œì„ íŒ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSSëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤ */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #1c1e21;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 15px;
            margin-top: 0;
        }

        .instruction {
            background: #e8f0fe;
            padding: 15px;
            border-left: 5px solid #1a73e8;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .upload-section {
            margin: 20px 0;
            padding: 40px;
            border: 3px dashed #1a73e8;
            border-radius: 12px;
            text-align: center;
            transition: background 0.3s;
        }

            .upload-section:hover {
                background: #f8fbff;
            }

        #fileInput {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

            button:hover {
                background-color: #1557b0;
            }

            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }

        #output {
            width: 100%;
            height: 500px;
            margin-top: 30px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
        }

        .status {
            margin-top: 15px;
            font-weight: bold;
            color: #5f6368;
        }

        .success {
            color: #1e8e3e;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“… ê°•ì˜ì‹œê°„í‘œ JSON ë³€í™˜ê¸° (ì•„í‚¤í…ì²˜ ê°œì„ íŒ)</h1>
        <div class="instruction">
            <strong>ì‹œìŠ¤í…œ ë¦¬íŒ©í† ë§ ì ìš© ì™„ë£Œ:</strong><br>
            - ğŸ—ï¸ <b>ë¹Œë” íŒ¨í„´ ë„ì…:</b> ê°•ì˜ ë°ì´í„° ì¡°ë¦½ì„ ì „ë‹´í•˜ëŠ” ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„±ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤.<br>
            - ğŸ”„ <b>FSM(ìƒíƒœ ê¸°ê³„) íŒŒì„œ:</b> ì—‘ì…€ ì…€ì„ ì½ëŠ” ë¡œì§ì„ 'ìƒíƒœ' ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì˜ˆì™¸ ì²˜ë¦¬ê°€ ê°•ë ¥í•´ì¡ŒìŠµë‹ˆë‹¤.<br>
            - â±ï¸ <b>ì‹œê°„ ì¸ì‹ ë²„ê·¸ ìˆ˜ì •:</b> SheetJS íŒŒì‹± ì‹œ `raw: false` ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ í…ìŠ¤íŠ¸ í¬ë§·ì„ ì •ìƒ ì¸ì‹í•©ë‹ˆë‹¤. [cite: 1]
        </div>

        <div class="upload-section">
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            <div class="status" id="status">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>

        <div class="btn-group">
            <button id="downloadJson" disabled>JSON ë‹¤ìš´ë¡œë“œ</button>
            <button id="downloadJs" disabled>data.js ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="output">// ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <script>
        // ==========================================
        // 1. ì„¤ì • ë° ìƒìˆ˜ (Constants)
        // ==========================================
        const IGNORE_KEYWORDS = ["ì „ì²´ì¶œì„ìœ¨", "ë‹¹ì¼ì¶œì„ìœ¨", "ì •ì› :", "ê°•ì‚¬ :", "ë°°ì •:", "ê°œ:", "ì¢…:", "ìˆ˜ì—…ì—†ìŒ", "ì„¤ì—°íœ´", "íœ´ê°•", "ê°œê°•ì—°ê¸°"];
        const DAY_PATTERNS = ["ì›”~ê¸ˆ", "ì›”/ìˆ˜/ê¸ˆ", "í™”/ëª©", "ê²©ì¼", "ì›”ìˆ˜ê¸ˆ", "í™”ëª©", "ì›”ìˆ˜ê¸ˆì›”ìˆ˜", "í™”ëª©í™”ëª©ê¸ˆ"];

        // ==========================================
        // 2. ê°•ì˜ ê°ì²´ ì¡°ë¦½ê¸° (Builder Pattern)
        // ==========================================
        class LectureBuilder {
            constructor(id, subject, room, startH, subRoom) {
                this.id = id;
                this.subject = subject;
                this.room = room;
                this.subRoom = subRoom;
                this.startH = startH;
                this.endH = startH + 2; // ê¸°ë³¸ 2ì‹œê°„ ê³ ì •

                // ìˆ˜ì§‘ë  ê¸°ë³¸ê°’ë“¤
                this.instructor = "";
                this.days = "ì›”~ê¸ˆ";
                this.startDate = "";
                this.endDate = "";
            }

            // ê°œë³„ ì†ì„± ì¶”ì¶œ ë° í• ë‹¹ ë¡œì§ì„ ìº¡ìŠí™”
            parseAttribute(val) {
                if (!val) return;

                // ê°•ì‚¬ ì¶”ì¶œ
                if (val.includes('ê°•ì‚¬ :')) {
                    this.instructor = val.replace('ê°•ì‚¬ :', '').trim();
                } else if (/^[ê°€-í£]{2,4}\d?$/.test(val) && !this.instructor) {
                    this.instructor = val.trim();
                }

                // ìš”ì¼ ì¶”ì¶œ
                if (DAY_PATTERNS.some(d => val.includes(d))) {
                    this.days = val.trim();
                }

                // ë‚ ì§œ ì¶”ì¶œ
                const dateMatch = val.match(/(\d{4}-\d{2}-\d{2})/);
                if (dateMatch) {
                    if (val.includes('ê°œ:')) this.startDate = dateMatch[1].substring(5); // MM-DD
                    if (val.includes('ì¢…:')) this.endDate = dateMatch[1].substring(5);   // MM-DD
                }
            }

            _getCategory(subject) {
                const s = subject.toLowerCase();
                if (s.includes('ì›¹íˆ°')) return 'webtoon';
                if (s.includes('ì´ëª¨í‹°ì½˜')) return 'emo';
                if (s.includes('í”„ë¡œê·¸ë˜ë°')) return 'prog-adv';
                if (s.includes('ê¸°íš')) return 'plan-adv';
                if (s.includes('ui') || s.includes('ux')) return 'ui';
                if (s.includes('ê·¸ë˜í”½')) return 'graphic';
                if (s.includes('ì›í™”') || s.includes('ìºë¦­í„°')) return 'art-adv';
                if (s.includes('ì•„íŠ¸ì›') || s.includes('ë“œë¡œì‰')) return 'art-basic';
                if (s.includes('êµ­]') || s.includes('k-digital') || s.includes('ì „ë¬¸ê°€ì–‘ì„±')) return 'kdigital';
                if (s.includes('í¬í´') || s.includes('í¬íŠ¸í´ë¦¬ì˜¤')) return 'port';
                return 'art-basic';
            }

            _calculateWeekType() {
                let weekType = "ALL";
                const dayStr = this.days.replace(/\s/g, "");

                if (dayStr.includes("í™”ëª©") || dayStr.includes("í™”/ëª©")) weekType = "A";
                else if (dayStr.includes("ì›”ìˆ˜ê¸ˆ") || dayStr.includes("ì›”/ìˆ˜/ê¸ˆ")) weekType = "B";

                if (this.subject.includes("ê²©ì¼") || this.days.includes("ê²©ì¼") || weekType !== "ALL") {
                    if (weekType === "ALL") {
                        if (this.subRoom.endsWith("-2")) weekType = "B";
                        else if (this.subRoom.endsWith("-1")) weekType = "A";
                    }
                }
                if (dayStr === "ì›”~ê¸ˆ") weekType = "ALL";

                return weekType;
            }

            // ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… JSON ê°ì²´ ìƒì„±
            build() {
                const finalDateInfo = (this.startDate && this.endDate) ? `${this.startDate} ~ ${this.endDate}` : "";
                const cleanInstructor = this.instructor.replace(/\d+$/, '').trim();

                return {
                    id: this.id,
                    subject: this.subject,
                    instructor: cleanInstructor,
                    room: this.room,
                    startH: this.startH,
                    endH: this.endH,
                    days: this.days,
                    dateInfo: finalDateInfo,
                    category: this._getCategory(this.subject),
                    weekType: this._calculateWeekType(),
                    isBadge: "",
                    fontSize: 14,
                    opacity: 100
                };
            }
        }

        // ==========================================
        // 3. FSM ê¸°ë°˜ ì‹œê°„í‘œ íŒŒì„œ (State Pattern)
        // ==========================================
        class TimetableParser {
            constructor(df) {
                this.df = df;
                this.lectures = [];
                this.lectureId = 1;
                this.roomMap = {};
                this.subRoomMap = {};
                this.timeMap = {};
            }

            parse() {
                this._buildAxes();
                const maxCols = this.df[0] ? this.df[0].length : 0;

                // íŒŒì´í”„ë¼ì¸ íë¦„: ê° ì—´(ê°•ì˜ì‹¤)ì„ ìˆœíšŒí•˜ë©° ìƒíƒœ ë¨¸ì‹ ì„ ëŒë¦½ë‹ˆë‹¤.
                for (let c = 1; c < maxCols; c++) {
                    if (!this.roomMap[c]) continue;
                    this._parseColumn(c);
                }
                return this.lectures;
            }

            // Xì¶•(ê°•ì˜ì‹¤), Yì¶•(ì‹œê°„) ë§µ êµ¬ì¶•
            _buildAxes() {
                let currentRoom = "";
                const firstRow = this.df[0] || [];
                const secondRow = this.df[1] || [];

                for (let c = 1; c < firstRow.length; c++) {
                    if (firstRow[c] && String(firstRow[c]).trim()) currentRoom = String(firstRow[c]).trim();
                    this.roomMap[c] = currentRoom;
                    this.subRoomMap[c] = String(secondRow[c] || "").trim(); // M-1, N-2 ë“±
                }

                let lastTime = null;
                for (let r = 0; r < this.df.length; r++) {
                    const tVal = this.df[r][0];
                    if (tVal && String(tVal).trim() && String(tVal).includes(':')) {
                        lastTime = String(tVal).trim();
                    }
                    this.timeMap[r] = lastTime;
                }
            }

            _isSubject(val) {
                if (!val) return false;
                const s = String(val).trim();
                if (s === "" || s === "undefined" || s === "null") return false;
                if (IGNORE_KEYWORDS.some(k => s.includes(k))) return false;
                if (DAY_PATTERNS.some(k => s === k)) return false;
                if (/^[ê°€-í£]{2,4}\d?$/.test(s)) return false;
                return true;
            }

            // ë‹¨ì¼ ì—´(Column) íŒŒì‹± - ìœ í•œ ìƒíƒœ ê¸°ê³„(FSM) ë„ì…
            _parseColumn(c) {
                let state = 'IDLE'; // ìƒíƒœ: IDLE(ëŒ€ê¸°) ë˜ëŠ” READING(ë°ì´í„° ìˆ˜ì§‘ ì¤‘)
                let currentBuilder = null;
                let lookaheadCount = 0;

                for (let r = 3; r < this.df.length; r++) {
                    const val = this.df[r][c];
                    const strVal = String(val || "").trim();

                    if (state === 'IDLE') {
                        // ëŒ€ê¸° ìƒíƒœì—ì„œ ê³¼ëª©ëª…ì„ ë§Œë‚˜ë©´ 'ìˆ˜ì§‘ ìƒíƒœ'ë¡œ ì „í™˜
                        if (this._isSubject(strVal)) {
                            const timeStr = this.timeMap[r];
                            const startH = timeStr ? parseInt(timeStr.split(':')[0]) : 0;

                            currentBuilder = new LectureBuilder(this.lectureId++, strVal, this.roomMap[c], startH, this.subRoomMap[c]);
                            state = 'READING';
                            lookaheadCount = 0;
                        }
                    }
                    else if (state === 'READING') {
                        // ìˆ˜ì§‘ ì¤‘ ìƒˆë¡œìš´ ê³¼ëª©ì„ ë§Œë‚˜ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ìƒˆë¡œ ì‹œì‘
                        if (this._isSubject(strVal)) {
                            this.lectures.push(currentBuilder.build());

                            const timeStr = this.timeMap[r];
                            const startH = timeStr ? parseInt(timeStr.split(':')[0]) : 0;

                            currentBuilder = new LectureBuilder(this.lectureId++, strVal, this.roomMap[c], startH, this.subRoomMap[c]);
                            lookaheadCount = 0;
                            continue;
                        }

                        // ê³¼ëª©ëª… ì•„ë˜ë¡œ 15ì¹¸ ì´ìƒ ê³µë°±/ë¬´íš¨ ë°ì´í„°ë©´ ìˆ˜ì§‘ ì¢…ë£Œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
                        if (lookaheadCount > 15) {
                            this.lectures.push(currentBuilder.build());
                            state = 'IDLE';
                            currentBuilder = null;
                            continue;
                        }

                        // ë¹Œë”ì—ê²Œ ë°ì´í„° ì†ì„± íŒŒì‹±ì„ ìœ„ì„
                        if (strVal) {
                            currentBuilder.parseAttribute(strVal);
                        }
                        lookaheadCount++;
                    }
                }

                // ì—´ íƒìƒ‰ì´ ëë‚¬ì„ ë•Œ ë‚¨ì•„ìˆëŠ” ìˆ˜ì§‘ ë°ì´í„° ì²˜ë¦¬
                if (currentBuilder) {
                    this.lectures.push(currentBuilder.build());
                }
            }
        }

        // ==========================================
        // 4. UI ë° ì´ë²¤íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬
        // ==========================================
        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        const downloadJsonBtn = document.getElementById('downloadJson');
        const downloadJsBtn = document.getElementById('downloadJs');

        let resultData = null;

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "íŒŒì¼ì„ ì½ê³  ë³€í™˜í•˜ëŠ” ì¤‘...";
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                // [í•µì‹¬ ë³€ê²½ì ] raw: false ì˜µì…˜ì„ ì£¼ì–´ ì—‘ì…€ì˜ ìˆ«ì í¬ë§·íŒ…ëœ ì‹œê°„ì„ í…ìŠ¤íŠ¸ í˜•íƒœ(09:00:00)ë¡œ ê°•ì œ ë°˜í™˜í•©ë‹ˆë‹¤.
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

                try {
                    const parser = new TimetableParser(rows);
                    resultData = parser.parse();

                    output.innerText = JSON.stringify(resultData, null, 2);
                    status.innerHTML = `<span class="success">ì„±ê³µ! ì´ ${resultData.length}ê°œì˜ ê°•ì˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.</span>`;
                    downloadJsonBtn.disabled = false;
                    downloadJsBtn.disabled = false;
                } catch (err) {
                    console.error(err);
                    status.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
                    output.innerText = err.stack;
                }
            };

            reader.readAsArrayBuffer(file);
        });

        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }

        downloadJsonBtn.onclick = () => downloadFile(JSON.stringify(resultData, null, 2), 'data.json', 'application/json');
        downloadJsBtn.onclick = () => downloadFile("const LECTURE_DATA = " + JSON.stringify(resultData, null, 2) + ";", 'data.js', 'text/javascript');

    </script>
</body>
</html>