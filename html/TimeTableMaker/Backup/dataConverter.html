<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì˜ì‹œê°„í‘œ Excel to JSON ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; line-height: 1.6; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .upload-section { margin: 20px 0; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; text-align: center; }
        #fileInput { margin-bottom: 10px; }
        .btn-group { margin-top: 10px; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 5px; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; }
        #output { width: 100%; height: 400px; margin-top: 20px; font-family: monospace; font-size: 12px; background: #272822; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow: auto; white-space: pre-wrap; }
        .status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“… ê°•ì˜ì‹œê°„í‘œ JSON ë³€í™˜ê¸°</h1>
    <p>ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ <code>LECTURE_DATA</code> í˜•ì‹ì˜ JSONìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>
    
    <div class="upload-section">
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
        <div class="status" id="status">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="btn-group">
        <button id="downloadJson" disabled>JSON ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadJs" disabled>data.js ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="output">// ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const output = document.getElementById('output');
    const status = document.getElementById('status');
    const downloadJsonBtn = document.getElementById('downloadJson');
    const downloadJsBtn = document.getElementById('downloadJs');
    
    let resultData = null;

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        status.innerText = "íŒŒì¼ ì½ëŠ” ì¤‘...";
        const reader = new FileReader();

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì„ íƒ
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            
            // 2ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            try {
                const lectures = parseTimetable(rows);
                resultData = lectures;
                const jsonStr = JSON.stringify(lectures, null, 2);
                output.innerText = jsonStr;
                status.innerText = `ì„±ê³µ! ${lectures.length}ê°œì˜ ê°•ì˜ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
                downloadJsonBtn.disabled = false;
                downloadJsBtn.disabled = false;
            } catch (err) {
                console.error(err);
                status.innerText = "ì˜¤ë¥˜ ë°œìƒ: íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                output.innerText = err.stack;
            }
        };

        reader.readAsArrayBuffer(file);
    });

    function parseTimetable(df) {
        const lectures = [];
        let lectureId = 1;

        // 1. ê°•ì˜ì‹¤ ë§¤í•‘ (Row 0 ê¸°ì¤€)
        const roomMap = {};
        let currentRoom = "";
        const firstRow = df[0] || [];
        for (let c = 1; c < firstRow.length; c++) {
            if (firstRow[c] && String(firstRow[c]).trim()) {
                currentRoom = String(firstRow[c]).trim();
            }
            roomMap[c] = currentRoom;
        }

        // 2. ì‹œê°„ ë§¤í•‘ (Col 0 ê¸°ì¤€)
        const timeMap = {};
        let lastTime = null;
        for (let r = 0; r < df.length; r++) {
            const tVal = df[r][0];
            if (tVal && String(tVal).trim() && String(tVal).includes(':')) {
                lastTime = String(tVal).trim();
            }
            timeMap[r] = lastTime;
        }

        const ignoreKeywords = ["ì „ì²´ì¶œì„ìœ¨", "ë‹¹ì¼ì¶œì„ìœ¨", "ì •ì› :", "ê°•ì‚¬ :", "ë°°ì •:", "ê°œ:", "ì¢…:", "ìˆ˜ì—…ì—†ìŒ", "ì„¤ì—°íœ´", "íœ´ê°•", "ê°œê°•ì—°ê¸°"];

        function isSubject(val) {
            if (!val) return false;
            const s = String(val).trim();
            if (s === "" || s === "undefined") return false;
            if (ignoreKeywords.some(k => s.includes(k))) return false;
            if (["ì›”~ê¸ˆ", "ì›”/ìˆ˜/ê¸ˆ", "í™”/ëª©", "ì›”ìˆ˜ê¸ˆ", "í™”ëª©"].some(k => s === k)) return false;
            // ê°•ì‚¬ëª… í•„í„°ë§ (í•œê¸€ 2~4ì + ìˆ«ì í˜•íƒœ ì œì™¸)
            if (/^[ê°€-í£]{2,4}\d?$/.test(s)) return false;
            return true;
        }

        function getCategory(subject) {
            const s = subject.toLowerCase();
            if (s.includes('ì›¹íˆ°')) return 'webtoon';
            if (s.includes('ì´ëª¨í‹°ì½˜')) return 'emo';
            if (s.includes('í”„ë¡œê·¸ë˜ë°')) return 'prog-adv';
            if (s.includes('ê¸°íš')) return 'plan-adv';
            if (s.includes('ui') || s.includes('ux')) return 'ui';
            if (s.includes('ê·¸ë˜í”½')) return 'graphic';
            if (s.includes('ì›í™”') || s.includes('ìºë¦­í„°')) return 'art-adv';
            if (s.includes('ì•„íŠ¸ì›') || s.includes('ë“œë¡œì‰')) return 'art-basic';
            if (s.includes('êµ­]') || s.includes('k-digital') || s.includes('ì „ë¬¸ê°€ì–‘ì„±')) return 'kdigital';
            if (s.includes('í¬í´') || s.includes('í¬íŠ¸í´ë¦¬ì˜¤')) return 'port';
            return 'art-basic';
        }

        const maxCols = df[0] ? df[0].length : 0;
        for (let c = 1; c < maxCols; c++) {
            const room = roomMap[c];
            if (!room) continue;

            for (let r = 3; r < df.length; r++) {
                const val = df[r][c];
                if (isSubject(val)) {
                    const subject = String(val).trim();
                    const startTimeStr = timeMap[r];
                    const startH = startTimeStr ? parseInt(startTimeStr.split(':')[0]) : 0;
                    
                    let instructor = "";
                    let days = "ì›”~ê¸ˆ";
                    let startDate = "";
                    let endDate = "";
                    
                    // ì„¸ë¶€ ì •ë³´ íƒìƒ‰
                    let searchR = r + 1;
                    while (searchR < df.length && !isSubject(df[searchR][c])) {
                        const mVal = String(df[searchR][c] || "");
                        if (mVal.includes('ê°•ì‚¬ :')) {
                            instructor = mVal.replace('ê°•ì‚¬ :', '').trim();
                        } else if (/^[ê°€-í£]{2,4}\d?$/.test(mVal) && instructor === "") {
                            instructor = mVal.trim();
                        }
                        
                        if (["ì›”~ê¸ˆ", "ì›”/ìˆ˜/ê¸ˆ", "í™”/ëª©", "ê²©ì¼", "ì›”ìˆ˜ê¸ˆ", "í™”ëª©"].some(d => mVal.includes(d))) {
                            days = mVal.trim();
                        }
                        
                        if (mVal.includes('ê°œ:')) {
                            const match = mVal.match(/(\d{4}-\d{2}-\d{2})/);
                            if (match) startDate = match[1].substring(5);
                        }
                        if (mVal.includes('ì¢…:')) {
                            const match = mVal.match(/(\d{4}-\d{2}-\d{2})/);
                            if (match) endDate = match[1].substring(5);
                        }
                        searchR++;
                    }

                    // ì¢…ë£Œ ì‹œê°„ ê³„ì‚° (ê¸°ë³¸ 2ì‹œê°„ ë˜ëŠ” ë‹¤ìŒ ìˆ˜ì—… ì‹œì‘ ì „ê¹Œì§€)
                    let endH = startH + 2;
                    if (searchR < df.length && timeMap[searchR]) {
                        const nextH = parseInt(timeMap[searchR].split(':')[0]);
                        if (nextH > startH) endH = nextH;
                    }

                    // ê°•ì‚¬ëª… ìˆ«ì ì œê±°
                    instructor = instructor.replace(/\d+$/, '').trim();

                    // weekType ê²°ì •
                    let weekType = "ALL";
                    if (days.includes("ê²©ì¼")) {
                        const subRoom = String(df[1][c] || "");
                        weekType = (subRoom.includes("-1")) ? "A" : "B";
                    } else if (days.includes("ì›”/ìˆ˜/ê¸ˆ") || days.includes("ì›”ìˆ˜ê¸ˆ")) {
                        weekType = "B";
                    }

                    lectures.push({
                        id: lectureId++,
                        subject: subject,
                        instructor: instructor,
                        room: room,
                        startH: startH,
                        endH: endH,
                        days: days,
                        dateInfo: (startDate && endDate) ? `${startDate} ~ ${endDate}` : "",
                        category: getCategory(subject),
                        weekType: weekType,
                        isBadge: "",
                        fontSize: 14,
                        opacity: 100
                    });
                    r = searchR - 1; // ë‹¤ìŒ ê²€ìƒ‰ ìœ„ì¹˜ë¡œ ì í”„
                }
            }
        }
        return lectures;
    }

    // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ë“¤
    function downloadFile(content, fileName, contentType) {
        const a = document.createElement("a");
        const file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
    }

    downloadJsonBtn.onclick = () => downloadFile(JSON.stringify(resultData, null, 2), 'data.json', 'application/json');
    downloadJsBtn.onclick = () => downloadFile("const LECTURE_DATA = " + JSON.stringify(resultData, null, 2) + ";", 'data.js', 'text/javascript');

</script>
</body>
</html>