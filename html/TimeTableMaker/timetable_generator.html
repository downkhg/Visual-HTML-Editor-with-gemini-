<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Generator & Editor (Dual Mode)</title>
    <style>
        /* ==================== 1. Editor UI Styles ==================== */
        :root {
            --bg-color: #1e272e;
            --panel-bg: #2d3436;
            --text-color: #f5f6fa;
            --accent-color: #0984e3;
            --border-color: rgba(255,255,255,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100vw;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Left Control Panel --- */
        aside {
            width: 340px; /* 패널 너비 약간 확장 */
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

            aside h2 {
                font-size: 1.1rem;
                margin-bottom: 15px;
                color: var(--accent-color);
            }

        .control-group {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

            .control-group label {
                display: block;
                margin-bottom: 6px;
                font-size: 0.8rem;
                color: #b2bec3;
            }

        input[type="file"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            background: #1e272e;
            border: 1px solid #636e72;
            color: white;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: var(--accent-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 5px;
            font-size: 0.85rem;
        }

            .btn:hover {
                background: #74b9ff;
            }

        .btn-success {
            background: #00b894;
        }

            .btn-success:hover {
                background: #55efc4;
            }

        .btn-toggle {
            background: #e17055;
            margin-bottom: 10px;
        }

            .btn-toggle:hover {
                background: #ff7675;
            }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        .input-wrap {
            flex: 1;
        }

        .sm-label {
            font-size: 0.7rem;
            color: #dfe6e9;
            margin-bottom: 2px;
            display: block;
        }

        /* --- Right Preview Stage --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .mode-indicator {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background: #636e72;
        }

        /* Scrollable Container */
        .stage-container {
            flex: 1;
            position: relative;
            display: flex;
            overflow: auto;
        }

        /* --- Timetable Grid --- */
        .time-col {
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
            background: #222f3e;
            position: sticky;
            left: 0;
            z-index: 50;
        }

        .grid-canvas {
            flex: 1;
            position: relative;
            min-width: 100%;
            min-height: 100%;
        }

        .time-label {
            position: absolute;
            right: 5px;
            font-size: 0.75rem;
            color: #b2bec3;
            transform: translateY(-50%);
        }

        .room-headers {
            display: flex;
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            position: absolute;
            top: 0;
            width: 100%;
            left: 0;
            background: #2d3436;
            z-index: 40;
        }

        .room-header {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
            font-size: 0.85rem;
            font-weight: bold;
        }

        .grid-lines {
            position: absolute;
            top: 40px;
            bottom: 0;
            left: 0;
            right: 0;
            pointer-events: none;
        }

        .h-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed rgba(255,255,255,0.05);
        }

        .v-line {
            position: absolute;
            top: 0;
            bottom: 0;
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        .card-layer {
            position: absolute;
            top: 40px;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .class-card {
            position: absolute;
            border-radius: 6px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid transparent;
            transition: transform 0.1s;
            line-height: 1.2;
        }

            .class-card.selected {
                border-color: #ffeaa7;
                z-index: 1000 !important;
                box-shadow: 0 0 15px rgba(255, 234, 167, 0.5);
                transform: scale(1.02);
            }

        /* [NEW] 요일 뱃지 스타일 */
        .day-badge {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            padding: 2px 8px;
            margin-top: 4px;
            display: inline-block;
            white-space: nowrap;
            font-weight: 500;
        }

        /* Categories */
        .cat-art-adv {
            background: #d63031;
        }

        .cat-prog-adv {
            background: #0984e3;
        }

        .cat-plan-adv {
            background: #f1c40f;
            color: #2d3436;
        }

        .cat-graphic {
            background: #6c5ce7;
        }

        .cat-webtoon {
            background: #e17055;
        }

        .cat-kdigital {
            background: #d35400;
        }

        .cat-default {
            background: #636e72;
        }
    </style>
</head>
<body>

    <aside>
        <h2>⚙️ Editor Control</h2>

        <div class="control-group">
            <label>Mode Setting</label>
            <button class="btn btn-toggle" id="btnToggleMode">Switch to Pixel (px) Mode</button>
            <p style="font-size:0.75rem; color:#b2bec3;">* Pixel mode allows scrollbars.</p>
        </div>

        <div class="control-group">
            <label>1. Load JSON Data</label>
            <input type="file" id="jsonFileInput" accept=".json, .js">
        </div>

        <div class="control-group">
            <label>2. Edit Selected Card</label>
            <div id="selectedCardInfo" style="margin-bottom:10px; font-size:0.9rem; color:#dfe6e9; min-height:20px;">No card selected</div>

            <label style="color:#74b9ff; margin-top:10px;">• Layout (<span id="unitLabel">%</span>)</label>
            <div class="input-row">
                <div class="input-wrap"><span class="sm-label">X</span><input type="number" id="inpLeft"></div>
                <div class="input-wrap"><span class="sm-label">Y</span><input type="number" id="inpTop"></div>
            </div>
            <div class="input-row">
                <div class="input-wrap"><span class="sm-label">W</span><input type="number" id="inpWidth"></div>
                <div class="input-wrap"><span class="sm-label">H</span><input type="number" id="inpHeight"></div>
            </div>

            <label style="color:#74b9ff; margin-top:10px;">• Individual Font Sizes (rem)</label>
            <div class="input-row">
                <div class="input-wrap">
                    <span class="sm-label">Subject</span>
                    <input type="number" id="inpSubjSize" step="0.05" placeholder="0.9">
                </div>
                <div class="input-wrap">
                    <span class="sm-label">Instructor</span>
                    <input type="number" id="inpInstSize" step="0.05" placeholder="0.8">
                </div>
                <div class="input-wrap">
                    <span class="sm-label">Day</span>
                    <input type="number" id="inpDaySize" step="0.05" placeholder="0.75">
                </div>
            </div>

            <label style="color:#74b9ff; margin-top:10px;">• Custom Text</label>
            <input type="text" id="inpSubject" placeholder="Override Subject">
            <input type="text" id="inpInstructor" placeholder="Override Instructor">
        </div>

        <div class="control-group" style="border:none;">
            <label>3. Export</label>
            <button class="btn btn-success" id="btnDownload">Download Viewer (.html)</button>
        </div>
    </aside>

    <main>
        <div class="header">
            <h3>Preview Stage</h3>
            <div class="mode-indicator" id="modeIndicator">Mode: Percent (%)</div>
        </div>
        <div class="stage-container" id="stageContainer">
            <div class="time-col" id="viewTimeCol"></div>
            <div class="grid-canvas" id="gridCanvas">
                <div class="room-headers" id="viewHeaders"></div>
                <div class="grid-lines" id="viewGridLines"></div>
                <div class="card-layer" id="viewCardLayer"></div>
            </div>
        </div>
    </main>

    <script>
        /**
         * =======================================================
         * [MODEL] Data & State
         * =======================================================
         */

        class ClassDTO {
            constructor(data) {
                this.id = data.id || Date.now();
                this.subject = data.subject;
                this.instructor = data.instructor;
                this.room = data.room;
                this.days = data.days;
                this.category = data.category || 'default';
                this.startH = parseInt(data.startH);
                this.endH = parseInt(data.endH);
            }
        }

        class ViewDTO {
            constructor(rect, coreData, mergedDays) {
                this.rect = rect;
                this.core = coreData;
                this.defaultText = { days: mergedDays };

                this.customText = {
                    subject: '',
                    instructor: ''
                };

                // [NEW] 개별 폰트 스타일 속성 (기본값 설정)
                this.style = {
                    subjSize: 0.9,  // 과목명 크기
                    instSize: 0.8,  // 강사명 크기
                    daySize: 0.75   // 요일 크기
                };
            }
        }

        class AppModel {
            constructor() {
                this.rawDTOs = [];
                this.viewDTOs = [];
                this.rooms = [];
                this.config = { start: 9, end: 22 };
                this.mode = 'percent';
                this.pxSettings = { colWidth: 150, hourHeight: 60 };

                this.onDataLoaded = null;
                this.onViewUpdated = null;
                this.onModeChanged = null;
            }

            loadData(jsonData) {
                this.rawDTOs = jsonData.map(d => new ClassDTO(d));
                this.rooms = [...new Set(this.rawDTOs.map(d => d.room))].sort();
                this.mode = 'percent';
                this._calculateInitialPercentLayout();
                if (this.onDataLoaded) this.onDataLoaded();
            }

            toggleMode() {
                const prevMode = this.mode;
                this.mode = (prevMode === 'percent') ? 'pixel' : 'percent';
                this._convertCoordinates(prevMode, this.mode);
                if (this.onModeChanged) this.onModeChanged(this.mode);
                if (this.onViewUpdated) this.onViewUpdated();
            }

            _convertCoordinates(from, to) {
                const totalHours = this.config.end - this.config.start;
                const totalHeightPx = totalHours * this.pxSettings.hourHeight;
                const totalWidthPx = this.rooms.length * this.pxSettings.colWidth;

                this.viewDTOs.forEach(dto => {
                    if (from === 'percent' && to === 'pixel') {
                        dto.rect.x = (dto.rect.x / 100) * totalWidthPx;
                        dto.rect.y = (dto.rect.y / 100) * totalHeightPx;
                        dto.rect.w = (dto.rect.w / 100) * totalWidthPx;
                        dto.rect.h = (dto.rect.h / 100) * totalHeightPx;
                    } else if (from === 'pixel' && to === 'percent') {
                        dto.rect.x = (dto.rect.x / totalWidthPx) * 100;
                        dto.rect.y = (dto.rect.y / totalHeightPx) * 100;
                        dto.rect.w = (dto.rect.w / totalWidthPx) * 100;
                        dto.rect.h = (dto.rect.h / totalHeightPx) * 100;
                    }
                });
            }

            _calculateInitialPercentLayout() {
                this.viewDTOs = [];
                const totalH = this.config.end - this.config.start;
                const colW = 100 / this.rooms.length;

                const grouped = this._groupItems();

                grouped.forEach(group => {
                    const item = group.items[0];
                    const roomIdx = this.rooms.indexOf(item.room);
                    const x = roomIdx * colW;
                    const y = ((item.startH - this.config.start) / totalH) * 100;
                    const w = colW;
                    const h = ((item.endH - item.startH) / totalH) * 100;
                    const days = this._mergeDays(group.items);
                    this.viewDTOs.push(new ViewDTO({ x, y, w, h }, item, days));
                });
            }

            updateCardRect(dto, newRect) { /* 생략(컨트롤러에서 직접 제어) */ }

            updateCardText(dto, type, value) {
                dto.customText[type] = value;
                if (this.onViewUpdated) this.onViewUpdated();
            }

            // [NEW] 개별 스타일 업데이트
            updateCardStyle(dto, type, value) {
                dto.style[type] = value;
                if (this.onViewUpdated) this.onViewUpdated();
            }

            _groupItems() {
                const map = new Map();
                this.rawDTOs.forEach(d => {
                    const key = `${d.subject}_${d.instructor}_${d.startH}_${d.room}`;
                    if (!map.has(key)) map.set(key, { items: [] });
                    map.get(key).items.push(d);
                });
                return Array.from(map.values());
            }
            _mergeDays(items) {
                const daysSet = new Set(items.map(i => i.days));
                const hasMWF = [...daysSet].some(d => d.includes('월') && d.includes('수'));
                const hasTT = [...daysSet].some(d => d.includes('화') && d.includes('목'));
                if (hasMWF && hasTT) return "월~금";
                return [...daysSet].join(", ");
            }

            getCanvasDimensions() {
                if (this.mode === 'percent') return { w: '100%', h: '100%' };
                return {
                    w: (this.rooms.length * this.pxSettings.colWidth) + 'px',
                    h: ((this.config.end - this.config.start) * this.pxSettings.hourHeight) + 'px'
                };
            }
        }

        /**
         * =======================================================
         * [VIEW] Editor UI
         * =======================================================
         */
        class EditorView {
            constructor() {
                this.els = {
                    timeCol: document.getElementById('viewTimeCol'),
                    headers: document.getElementById('viewHeaders'),
                    gridLines: document.getElementById('viewGridLines'),
                    cardLayer: document.getElementById('viewCardLayer'),
                    gridCanvas: document.getElementById('gridCanvas'),

                    inpLeft: document.getElementById('inpLeft'),
                    inpTop: document.getElementById('inpTop'),
                    inpWidth: document.getElementById('inpWidth'),
                    inpHeight: document.getElementById('inpHeight'),

                    inpSubject: document.getElementById('inpSubject'),
                    inpInstructor: document.getElementById('inpInstructor'),

                    // [NEW] Individual Font Inputs
                    inpSubjSize: document.getElementById('inpSubjSize'),
                    inpInstSize: document.getElementById('inpInstSize'),
                    inpDaySize: document.getElementById('inpDaySize'),

                    info: document.getElementById('selectedCardInfo'),
                    unitLabel: document.getElementById('unitLabel'),
                    modeIndicator: document.getElementById('modeIndicator'),
                    btnToggle: document.getElementById('btnToggleMode')
                };
                this.selectedCardEl = null;
            }

            updateModeUI(mode) {
                const isPx = mode === 'pixel';
                this.els.unitLabel.textContent = isPx ? 'px' : '%';
                this.els.modeIndicator.textContent = isPx ? 'Mode: Pixel (px)' : 'Mode: Percent (%)';
                this.els.btnToggle.textContent = isPx ? 'Switch to Percent (%) Mode' : 'Switch to Pixel (px) Mode';

                const inputs = [this.els.inpLeft, this.els.inpTop, this.els.inpWidth, this.els.inpHeight];
                inputs.forEach(inp => inp.step = isPx ? 1 : 0.1);
            }

            renderStage(model) {
                const config = model.config;
                const rooms = model.rooms;
                const dim = model.getCanvasDimensions();

                this.els.gridCanvas.style.width = dim.w;
                this.els.gridCanvas.style.height = dim.h;
                this.els.cardLayer.style.height = dim.h;

                this.els.timeCol.innerHTML = '';
                this.els.headers.innerHTML = '';
                this.els.gridLines.innerHTML = '';

                const isPx = model.mode === 'pixel';
                const totalH = config.end - config.start;

                for (let h = config.start; h <= config.end; h++) {
                    let posVal = isPx
                        ? (h - config.start) * model.pxSettings.hourHeight + "px"
                        : ((h - config.start) / totalH) * 100 + "%";

                    const lbl = document.createElement('div');
                    lbl.className = 'time-label';
                    lbl.textContent = `${h}:00`;
                    lbl.style.top = posVal;
                    this.els.timeCol.appendChild(lbl);

                    if (h !== config.end) {
                        const line = document.createElement('div');
                        line.className = 'h-line';
                        line.style.top = posVal;
                        this.els.gridLines.appendChild(line);
                    }
                }

                rooms.forEach((room, i) => {
                    const hd = document.createElement('div');
                    hd.className = 'room-header';
                    hd.textContent = room;
                    this.els.headers.appendChild(hd);

                    if (i > 0) {
                        const vl = document.createElement('div');
                        vl.className = 'v-line';
                        let leftVal = isPx
                            ? i * model.pxSettings.colWidth + "px"
                            : (i / rooms.length) * 100 + "%";
                        vl.style.left = leftVal;
                        this.els.gridLines.appendChild(vl);
                    }
                });
            }

            renderCards(model, onCardClick) {
                this.els.cardLayer.innerHTML = '';
                const unit = model.mode === 'pixel' ? 'px' : '%';

                model.viewDTOs.forEach(dto => {
                    const el = document.createElement('div');
                    el.className = `class-card cat-${dto.core.category}`;

                    el.style.left = dto.rect.x + unit;
                    el.style.top = dto.rect.y + unit;
                    el.style.width = dto.rect.w + unit;
                    el.style.height = dto.rect.h + unit;

                    const subject = dto.customText.subject || dto.core.subject;
                    const instructor = dto.customText.instructor || dto.core.instructor;
                    const days = dto.defaultText.days;

                    // [NEW] 개별 폰트 사이즈 및 뱃지 스타일 적용
                    el.innerHTML = `
                            <div style="font-weight:800; font-size:${dto.style.subjSize}rem; margin-bottom:2px; word-break:keep-all;">${subject}</div>
                            <div style="opacity:0.9; font-size:${dto.style.instSize}rem;">${instructor}</div>
                            <div class="day-badge" style="font-size:${dto.style.daySize}rem;">${days}</div>
                        `;

                    el.onclick = (e) => {
                        e.stopPropagation();
                        this._selectCard(el, dto);
                        onCardClick(dto);
                    };

                    this.els.cardLayer.appendChild(el);
                });
            }

            _selectCard(el, dto) {
                if (this.selectedCardEl) this.selectedCardEl.classList.remove('selected');
                el.classList.add('selected');
                this.selectedCardEl = el;

                this.els.info.innerHTML = `Selected: <b style="color:white;">${dto.core.subject}</b>`;

                this.els.inpLeft.value = parseFloat(dto.rect.x.toFixed(2));
                this.els.inpTop.value = parseFloat(dto.rect.y.toFixed(2));
                this.els.inpWidth.value = parseFloat(dto.rect.w.toFixed(2));
                this.els.inpHeight.value = parseFloat(dto.rect.h.toFixed(2));

                // [NEW] 3개의 폰트 사이즈 바인딩
                this.els.inpSubjSize.value = dto.style.subjSize;
                this.els.inpInstSize.value = dto.style.instSize;
                this.els.inpDaySize.value = dto.style.daySize;

                this.els.inpSubject.value = dto.customText.subject || '';
                this.els.inpSubject.placeholder = dto.core.subject;
                this.els.inpInstructor.value = dto.customText.instructor || '';
                this.els.inpInstructor.placeholder = dto.core.instructor;
            }
        }

        /**
         * =======================================================
         * [CONTROLLER] Logic
         * =======================================================
         */
        class Controller {
            constructor(model, view) {
                this.model = model;
                this.view = view;
                this.currentSelectedDTO = null;
                this._initEvents();
            }

            _initEvents() {
                // 1. Data Load
                document.getElementById('jsonFileInput').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            let content = evt.target.result;
                            if (content.includes('=')) content = content.split('=')[1];
                            if (content.trim().endsWith(';')) content = content.trim().slice(0, -1);
                            this.model.loadData(JSON.parse(content));
                        } catch (err) { alert("Parsing Error"); }
                    };
                    reader.readAsText(file);
                });

                // 2. Mode Toggle
                document.getElementById('btnToggleMode').addEventListener('click', () => {
                    this.model.toggleMode();
                });

                // 3. Model Listeners
                this.model.onDataLoaded = () => this._refreshAll();
                this.model.onModeChanged = (mode) => {
                    this.view.updateModeUI(mode);
                    this._refreshAll();
                };
                this.model.onViewUpdated = () => {
                    this.view.renderCards(this.model, (dto) => {
                        this.currentSelectedDTO = dto;
                    });
                };

                // 4. Input Bindings (Coordinates)
                ['inpLeft', 'inpTop', 'inpWidth', 'inpHeight'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        if (!this.currentSelectedDTO) return;
                        const val = parseFloat(e.target.value);
                        if (isNaN(val)) return;

                        const rect = { ...this.currentSelectedDTO.rect };
                        if (id === 'inpLeft') rect.x = val;
                        if (id === 'inpTop') rect.y = val;
                        if (id === 'inpWidth') rect.w = val;
                        if (id === 'inpHeight') rect.h = val;

                        // UI Update
                        if (this.view.selectedCardEl) {
                            const unit = this.model.mode === 'pixel' ? 'px' : '%';
                            if (id === 'inpLeft') this.view.selectedCardEl.style.left = val + unit;
                            if (id === 'inpTop') this.view.selectedCardEl.style.top = val + unit;
                            if (id === 'inpWidth') this.view.selectedCardEl.style.width = val + unit;
                            if (id === 'inpHeight') this.view.selectedCardEl.style.height = val + unit;
                        }
                        this.currentSelectedDTO.rect = rect;
                    });
                });

                // 5. Input Bindings (Text)
                document.getElementById('inpSubject').addEventListener('input', (e) => {
                    if (!this.currentSelectedDTO) return;
                    this.model.updateCardText(this.currentSelectedDTO, 'subject', e.target.value);
                });
                document.getElementById('inpInstructor').addEventListener('input', (e) => {
                    if (!this.currentSelectedDTO) return;
                    this.model.updateCardText(this.currentSelectedDTO, 'instructor', e.target.value);
                });

                // [NEW] Input Bindings (Individual Font Sizes)
                // Helper function to bind font inputs
                const bindFontInput = (id, type) => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        if (!this.currentSelectedDTO) return;
                        const val = parseFloat(e.target.value);
                        if (isNaN(val) || val <= 0) return;

                        this.model.updateCardStyle(this.currentSelectedDTO, type, val);
                    });
                };

                bindFontInput('inpSubjSize', 'subjSize');
                bindFontInput('inpInstSize', 'instSize');
                bindFontInput('inpDaySize', 'daySize');

                // 6. Download
                document.getElementById('btnDownload').addEventListener('click', () => this._downloadHTML());
            }

            _refreshAll() {
                this.view.renderStage(this.model);
                this.view.renderCards(this.model, (dto) => this.currentSelectedDTO = dto);
            }

            _downloadHTML() {
                if (this.model.viewDTOs.length === 0) { alert("No data"); return; }
                const exportData = JSON.stringify(this.model.viewDTOs);
                const roomsData = JSON.stringify(this.model.rooms);
                const mode = this.model.mode;
                const htmlContent = this._generateHTMLTemplate(exportData, roomsData, mode);

                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'timetableVeiw.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            _generateHTMLTemplate(dataJson, roomsJson, mode) {
                const isPx = mode === 'pixel';
                const unit = isPx ? 'px' : '%';
                const containerStyle = isPx ? 'overflow: auto;' : 'overflow: hidden;';
                const canvasStyle = isPx
                    ? `width: ${this.model.getCanvasDimensions().w}; height: ${this.model.getCanvasDimensions().h};`
                    : 'width: 100%; height: 100%;';

                return `<!DOCTYPE html>
<html lang="ko">
<head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Timetable Viewer (${mode})</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
                body { background-color: #1e272e; color: #f5f6fa; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
                .header { height: 60px; display: flex; align-items: center; justify-content: center; background: #2d3436; flex-shrink: 0; }
                .header h1 { font-size: 1.5rem; color: #74b9ff; }

                .stage-wrap { flex: 1; position: relative; display: flex; ${containerStyle} }
                .time-col { width: 60px; background: #222f3e; border-right: 1px solid rgba(255,255,255,0.1); position: sticky; left: 0; z-index: 50; flex-shrink: 0; }

                .grid-canvas { position: relative; ${canvasStyle} }

                .time-label { position: absolute; right: 5px; font-size: 0.75rem; color: #b2bec3; transform: translateY(-50%); }
                .room-headers { display: flex; height: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); position: absolute; top: 0; width: 100%; background: #2d3436; z-index: 40; }
                .room-header { flex: 1; display: flex; align-items: center; justify-content: center; border-right: 1px solid rgba(255,255,255,0.1); font-weight: bold; font-size: 0.9rem; }
                .grid-lines { position: absolute; top: 40px; bottom: 0; left: 0; right: 0; pointer-events: none; }
                .h-line { position: absolute; left: 0; right: 0; border-top: 1px dashed rgba(255,255,255,0.05); }
                .v-line { position: absolute; top: 0; bottom: 0; border-right: 1px solid rgba(255,255,255,0.05); }

                .class-card {
                    position: absolute; border-radius: 6px; padding: 6px;
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                    text-align: center; color: white;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3); overflow: hidden;
                    transition: transform 0.2s; cursor: pointer; line-height: 1.2;
                }
                .class-card:hover { transform: scale(1.05); z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

                /* Badge Style */
                .day-badge {
                    background: rgba(0, 0, 0, 0.25);
                    border-radius: 12px;
                    padding: 2px 8px;
                    margin-top: 4px;
                    display: inline-block;
                    white-space: nowrap;
                    font-weight: 500;
                }

                .cat-art-adv { background: #d63031; } .cat-prog-adv { background: #0984e3; }
                .cat-plan-adv { background: #f1c40f; color: #2d3436; } .cat-graphic { background: #6c5ce7; }
                .cat-webtoon { background: #e17055; } .cat-kdigital { background: #d35400; }
                .cat-default { background: #636e72; }
            </style>
</head>
<body>
            <div class="header"><h1>ACADEMY TIMETABLE</h1></div>
            <div class="stage-wrap">
                <div class="time-col" id="tCol"></div>
                <div class="grid-canvas">
                    <div class="room-headers" id="rHead"></div>
                    <div class="grid-lines" id="gLine"></div>
                    <div id="cLayer"></div>
                </div>
            </div>
            <script>
                const DATA = ${dataJson};
                const ROOMS = ${roomsJson};
                const CONFIG = { start: 9, end: 22 };
                const UNIT = '${unit}';
                const IS_PX = ${isPx};
                const PX_SET = { colW: 150, hourH: 60 };

                document.addEventListener('DOMContentLoaded', () => {
                    const tCol = document.getElementById('tCol');
                    const rHead = document.getElementById('rHead');
                    const gLine = document.getElementById('gLine');
                    const cLayer = document.getElementById('cLayer');
                    const totalH = CONFIG.end - CONFIG.start;

                    for(let h=CONFIG.start; h<=CONFIG.end; h++) {
                        let pos = IS_PX
                            ? (h - CONFIG.start) * PX_SET.hourH + 'px'
                            : ((h - CONFIG.start) / totalH) * 100 + '%';
                        const l = document.createElement('div'); l.className='time-label'; l.innerText = h+":00"; l.style.top=pos; tCol.appendChild(l);
                        if(h !== CONFIG.end){
                            const hl = document.createElement('div'); hl.className='h-line'; hl.style.top=pos; gLine.appendChild(hl);
                        }
                    }
                    ROOMS.forEach((r, i) => {
                        const rh = document.createElement('div'); rh.className='room-header'; rh.innerText=r; rHead.appendChild(rh);
                        if(i>0) {
                            const vl = document.createElement('div'); vl.className='v-line';
                            let left = IS_PX ? i * PX_SET.colW + 'px' : (i/ROOMS.length)*100 + '%';
                            vl.style.left=left; gLine.appendChild(vl);
                        }
                    });

                    DATA.forEach(dto => {
                        const el = document.createElement('div');
                        el.className = 'class-card cat-' + dto.core.category;
                        el.style.left = dto.rect.x + UNIT;
                        el.style.top = dto.rect.y + UNIT;
                        el.style.width = dto.rect.w + UNIT;
                        el.style.height = dto.rect.h + UNIT;

                        const subject = dto.customText.subject || dto.core.subject;
                        const instructor = dto.customText.instructor || dto.core.instructor;
                        const days = dto.defaultText.days;

                        // [Export] 개별 폰트 스타일 및 뱃지 적용
                        el.innerHTML = "<div style='font-weight:800; margin-bottom:2px; word-break:keep-all; font-size:" + dto.style.subjSize + "rem'>" + subject + "</div>" +
                                       "<div style='opacity:0.9; font-size:" + dto.style.instSize + "rem'>" + instructor + "</div>" +
                                       "<div class='day-badge' style='font-size:" + dto.style.daySize + "rem'>" + days + "</div>";
                        cLayer.appendChild(el);
                    });
                });
            <\/script>
</body>
</html>`;
            }
        }

        const appModel = new AppModel();
        const appView = new EditorView();
        const appController = new Controller(appModel, appView);

    </script>
</body>
</html>