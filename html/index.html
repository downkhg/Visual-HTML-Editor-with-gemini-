<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual HTML Editor v0.04</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- 에디터 UI 스타일 --- */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Pretendard', sans-serif;
        }

        #app-container {
            display: flex;
            height: 100vh;
            background-color: #0f172a;
        }

        /* 사이드바 */
        #sidebar {
            width: 360px;
            background-color: #1e293b;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            z-index: 20;
            overflow-y: auto;
        }

        #sidebar::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 3px;
        }

        /* 메인 영역 */
        #editor-canvas {
            flex: 1;
            background-color: #cbd5e1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* 아이프레임 */
        #content-frame {
            background: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #content-frame.mobile {
            width: 375px;
            height: 667px;
            border-radius: 20px;
            border: 8px solid #333;
        }

        #content-frame.tablet {
            width: 768px;
            height: 1024px;
            border-radius: 12px;
            border: 8px solid #333;
        }

        #content-frame.desktop {
            width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
        }

        /* UI 컴포넌트 */
        .panel-section {
            padding: 16px;
            border-bottom: 1px solid #334155;
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 0.05em;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 8px;
        }

        .control-label {
            font-size: 0.75rem;
            color: #cbd5e1;
            white-space: nowrap;
        }

        /* Inputs */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        input[type="range"] {
            width: 100%;
            accent-color: #3b82f6;
            height: 4px;
            border-radius: 2px;
        }

        /* Buttons */
        .btn {
            background-color: #334155;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            background-color: #475569;
        }

        .btn.danger {
            background-color: #ef4444;
            color: white;
        }

        .btn.active {
            background-color: #3b82f6;
            color: white;
            border: 1px solid #60a5fa;
        }

        .btn-icon {
            padding: 6px;
            width: 32px;
            height: 32px;
        }

        .btn-group {
            display: flex;
            gap: 1px;
            background: #334155;
            padding: 2px;
            border-radius: 4px;
        }

        .btn-group .btn {
            flex: 1;
            background: transparent;
            padding: 4px;
            height: 28px;
        }

        .btn-group .btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-group .btn.active {
            background: #2563eb;
        }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .icon-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #334155;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #475569;
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <div id="app-container">
        <aside id="sidebar">
            <div class="panel-section bg-slate-900 sticky top-0 z-10">
                <div class="flex items-center gap-3 mb-4">
                    <div
                        class="w-12 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white text-xs shadow-lg">
                        v.04</div>
                    <h1 class="font-bold text-sm">Visual Editor <span class="text-slate-500 font-normal">v0.04</span>
                    </h1>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="document.getElementById('file-upload').click()" class="btn flex-1"><i
                            class="fa-solid fa-folder-open"></i> 열기</button>
                    <button onclick="app.saveHTML()" class="btn flex-1 text-green-400"><i
                            class="fa-solid fa-download"></i> 저장</button>
                </div>
                <input type="file" id="file-upload" accept=".html,.htm" hidden>

                <div class="flex gap-2">
                    <button onclick="app.undo()" class="btn flex-1 text-yellow-400" title="Ctrl+Z"><i
                            class="fa-solid fa-rotate-left"></i> Undo</button>
                    <button onclick="app.redo()" class="btn flex-1 text-yellow-400" title="Ctrl+Y"><i
                            class="fa-solid fa-rotate-right"></i> Redo</button>
                </div>
            </div>

            <div class="panel-section border-b border-slate-700 bg-slate-800/50">
                <div class="section-title">
                    <span>Selection</span>
                    <span id="selected-tag-display" class="text-xs text-blue-300 font-mono">none</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.selectParent()" class="btn btn-icon flex-1" title="부모 선택 (UP)"><i
                            class="fa-solid fa-arrow-up"></i></button>
                    <button onclick="app.cloneSelected()" class="btn btn-icon flex-1" title="복제"><i
                            class="fa-regular fa-clone"></i></button>
                    <button onclick="app.deleteSelected()" class="btn btn-icon flex-1 danger" title="삭제"><i
                            class="fa-solid fa-trash"></i></button>
                </div>
            </div>

            <div id="icon-panel" class="panel-section bg-slate-800 hidden border-l-4 border-purple-500">
                <div class="section-title text-purple-300">Pictogram</div>
                <div class="mb-2">
                    <input type="text" placeholder="Search icons..." onkeyup="app.renderIconGrid(this.value)"
                        class="text-xs">
                </div>
                <div id="icon-grid-container" class="icon-grid"></div>
            </div>

            <div class="panel-section">
                <div class="section-title">Typography</div>

                <div class="mb-2">
                    <label class="control-label block mb-1">폰트 (Font Family)</label>
                    <select class="style-control" data-style-prop="fontFamily">
                        <option value="">기본 (Inherit)</option>
                        <option value="'Jua', sans-serif">Jua (둥근체)</option>
                        <option value="'Comfortaa', cursive">Comfortaa (영문 둥근체)</option>
                        <option value="sans-serif">Sans Serif (고딕)</option>
                        <option value="serif">Serif (명조)</option>
                        <option value="monospace">Monospace (코딩)</option>
                    </select>
                </div>

                <div class="control-row">
                    <span class="control-label">색상</span>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <input type="color" class="style-control" data-style-prop="color">
                    </div>
                </div>

                <div class="control-grid mb-2">
                    <div>
                        <label class="control-label block mb-1">크기 (px)</label>
                        <input type="number" class="style-control" data-style-prop="fontSize" data-unit="px">
                    </div>
                    <div>
                        <label class="control-label block mb-1">줄 간격</label>
                        <input type="number" step="0.1" class="style-control" data-style-prop="lineHeight">
                    </div>
                </div>

                <div class="btn-group mb-2">
                    <button class="btn style-btn" data-style-prop="textAlign" data-value="left"><i
                            class="fa-solid fa-align-left"></i></button>
                    <button class="btn style-btn" data-style-prop="textAlign" data-value="center"><i
                            class="fa-solid fa-align-center"></i></button>
                    <button class="btn style-btn" data-style-prop="textAlign" data-value="right"><i
                            class="fa-solid fa-align-right"></i></button>
                    <button class="btn style-btn" data-style-prop="textAlign" data-value="justify"><i
                            class="fa-solid fa-align-justify"></i></button>
                </div>

                <div class="btn-group">
                    <button class="btn style-toggle" data-style-prop="fontWeight" data-on="bold" data-off="normal"><i
                            class="fa-solid fa-bold"></i></button>
                    <button class="btn style-toggle" data-style-prop="fontStyle" data-on="italic" data-off="normal"><i
                            class="fa-solid fa-italic"></i></button>
                    <button class="btn style-toggle" data-style-prop="textDecoration" data-on="underline"
                        data-off="none"><i class="fa-solid fa-underline"></i></button>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Layout & Spacing</div>

                <div class="mb-2">
                    <label class="control-label block mb-1">배치 (Display)</label>
                    <select class="style-control" data-style-prop="display" id="input-display">
                        <option value="block">Block</option>
                        <option value="flex">Flex (정렬 컨테이너)</option>
                        <option value="inline">Inline</option>
                        <option value="inline-block">Inline-Block</option>
                        <option value="grid">Grid</option>
                        <option value="none">None (숨김)</option>
                    </select>
                </div>

                <div id="flex-controls" class="bg-slate-800 p-2 rounded mb-2 hidden">
                    <label class="control-label block mb-1 text-blue-300">Flex 정렬</label>
                    <div class="control-row">
                        <span class="control-label text-xs">가로</span>
                        <select class="style-control text-xs" data-style-prop="justifyContent">
                            <option value="flex-start">시작 (Left)</option>
                            <option value="center">중앙 (Center)</option>
                            <option value="flex-end">끝 (Right)</option>
                            <option value="space-between">양끝 (Between)</option>
                            <option value="space-around">균등 (Around)</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label text-xs">세로</span>
                        <select class="style-control text-xs" data-style-prop="alignItems">
                            <option value="stretch">채우기 (Stretch)</option>
                            <option value="flex-start">상단 (Top)</option>
                            <option value="center">중앙 (Middle)</option>
                            <option value="flex-end">하단 (Bottom)</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label text-xs">Gap</span>
                        <input type="text" class="style-control text-xs" data-style-prop="gap" placeholder="10px">
                    </div>
                </div>

                <div class="control-grid">
                    <div>
                        <label class="control-label block mb-1">Pad</label>
                        <input type="text" class="style-control" data-style-prop="padding" placeholder="10px">
                    </div>
                    <div>
                        <label class="control-label block mb-1">Margin</label>
                        <input type="text" class="style-control" data-style-prop="margin" placeholder="0 auto">
                    </div>
                    <div>
                        <label class="control-label block mb-1">W</label>
                        <input type="text" class="style-control" data-style-prop="width" placeholder="100%">
                    </div>
                    <div>
                        <label class="control-label block mb-1">H</label>
                        <input type="text" class="style-control" data-style-prop="height" placeholder="auto">
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Decoration</div>

                <div class="control-row">
                    <span class="control-label">배경색</span>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <input type="color" class="style-control" data-style-prop="backgroundColor">
                    </div>
                </div>

                <div class="mb-3">
                    <div class="control-row">
                        <label class="control-label">Radius</label>
                        <span id="radius-val" class="text-xs text-blue-300">0px</span>
                    </div>
                    <input type="range" class="style-control" data-style-prop="borderRadius" data-unit="px" min="0"
                        max="100" value="0"
                        oninput="document.getElementById('radius-val').innerText = this.value + 'px'">
                </div>

                <div class="mb-3">
                    <label class="control-label block mb-1">테두리 (Border)</label>
                    <div class="flex gap-1">
                        <input type="number" id="border-width" placeholder="px" style="width: 50px"
                            class="border-group">
                        <select id="border-style" class="border-group">
                            <option value="none">없음</option>
                            <option value="solid">실선</option>
                            <option value="dashed">점선</option>
                            <option value="dotted">도트</option>
                        </select>
                        <input type="color" id="border-color" value="#000000" class="border-group">
                    </div>
                </div>

                <div class="mb-1">
                    <label class="control-label block mb-1">그림자 (Shadow)</label>
                    <div class="btn-group">
                        <button class="btn style-btn flex-1 text-xs" data-style-prop="boxShadow"
                            data-value="none">X</button>
                        <button class="btn style-btn flex-1 text-xs" data-style-prop="boxShadow"
                            data-value="0 2px 5px rgba(0,0,0,0.1)">약</button>
                        <button class="btn style-btn flex-1 text-xs" data-style-prop="boxShadow"
                            data-value="0 10px 20px rgba(0,0,0,0.15)">중</button>
                        <button class="btn style-btn flex-1 text-xs" data-style-prop="boxShadow"
                            data-value="0 20px 50px rgba(0,0,0,0.25)">강</button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Advanced</div>

                <div class="mb-2" id="img-control-group" style="display:none;">
                    <label class="control-label block mb-1">이미지 소스 (SRC)</label>
                    <div class="flex gap-1">
                        <input type="text" id="input-src" class="text-xs"
                            onchange="app.applyAttribute('src', this.value)">
                        <button onclick="document.getElementById('img-changer').click()" class="btn btn-icon"><i
                                class="fa-regular fa-image"></i></button>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="control-label block mb-1">Classes</label>
                    <input type="text" id="input-classes" onchange="app.applyClasses(this.value)">
                </div>

                <div>
                    <button onclick="app.toggleHtmlEdit()" class="btn w-full text-xs mb-1">Raw HTML 편집 <i
                            class="fa-solid fa-code ml-1"></i></button>
                    <textarea id="input-html" rows="4" class="font-mono text-xs hidden"
                        onchange="app.applyOuterHTML(this.value)"></textarea>
                </div>
            </div>

            <div class="mt-auto panel-section bg-slate-900 border-t border-slate-700">
                <div class="flex gap-2">
                    <button onclick="app.setDevice('desktop')" class="btn flex-1"><i
                            class="fa-solid fa-desktop"></i></button>
                    <button onclick="app.setDevice('tablet')" class="btn flex-1"><i
                            class="fa-solid fa-tablet-screen-button"></i></button>
                    <button onclick="app.setDevice('mobile')" class="btn flex-1"><i
                            class="fa-solid fa-mobile-screen-button"></i></button>
                </div>
            </div>
        </aside>

        <main id="editor-canvas" onclick="app.deselectAll(event)">
            <iframe id="content-frame" class="desktop"></iframe>
        </main>
    </div>

    <input type="file" id="img-changer" accept="image/*" hidden>

    <script>
        /**
         * GUIManager Class
         * - 모든 UI 이벤트와 스타일 동기화를 중앙에서 관리
         */
        class GUIManager {
            constructor() {
                this.controls = [];
                this.init();
            }

            init() {
                // 1. Style Control Inputs (Input, Select)
                const inputs = document.querySelectorAll('.style-control');
                inputs.forEach(el => {
                    this.controls.push(el);
                    el.addEventListener('input', (e) => this.handleInput(e));
                    el.addEventListener('change', (e) => this.handleInput(e)); // for color picker compat
                });

                // 2. Style Buttons (Alignment, Shadow etc)
                const btns = document.querySelectorAll('.style-btn');
                btns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const prop = btn.dataset.styleProp;
                        const val = btn.dataset.value;
                        app.applyStyle(prop, val);
                        this.syncUI(app.selectedEl); // 버튼 클릭 시 UI 갱신 (Active 상태 변경 등)
                    });
                });

                // 3. Style Toggles (Bold, Italic)
                const toggles = document.querySelectorAll('.style-toggle');
                toggles.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const prop = btn.dataset.styleProp;
                        const onVal = btn.dataset.on;
                        const offVal = btn.dataset.off;
                        app.toggleStyle(prop, onVal, offVal);
                    });
                });

                // 4. Border Group (Complex Logic)
                const borderInputs = document.querySelectorAll('.border-group');
                borderInputs.forEach(el => {
                    el.addEventListener('change', () => this.handleBorderChange());
                    el.addEventListener('input', () => this.handleBorderChange());
                });
            }

            // Input Event Handler
            handleInput(e) {
                if (!app.selectedEl) return;
                const target = e.target;
                const prop = target.dataset.styleProp;
                let val = target.value;
                const unit = target.dataset.unit || '';

                if (val && unit && !val.includes(unit)) {
                    val += unit;
                }

                app.applyStyle(prop, val);

                // 특수 로직: Display 변경 시 사이드바 UI 갱신 필요
                if (prop === 'display') {
                    this.syncUI(app.selectedEl);
                }
            }

            handleBorderChange() {
                if (!app.selectedEl) return;
                const w = document.getElementById('border-width').value;
                const s = document.getElementById('border-style').value;
                const c = document.getElementById('border-color').value;

                if (s === 'none') {
                    app.selectedEl.style.border = 'none';
                } else {
                    const width = w ? w + 'px' : '1px';
                    app.selectedEl.style.border = `${width} ${s} ${c}`;
                }
                app.saveState();
            }

            // Sync UI with Selected Element
            syncUI(el) {
                if (!el) {
                    // Reset or Disable UI
                    return;
                }

                const s = window.getComputedStyle(el);
                const styleRaw = el.style;

                // 1. Auto-sync inputs based on data-style-prop
                this.controls.forEach(ctrl => {
                    const prop = ctrl.dataset.styleProp;
                    if (!prop) return;

                    let val = styleRaw[prop] || s[prop]; // 우선 인라인 스타일, 없으면 computed

                    // Color conversion
                    if (prop.toLowerCase().includes('color')) {
                        val = app.rgbToHex(val);
                    }
                    // Font Family cleanup
                    if (prop === 'fontFamily') {
                        val = app.getFontFamilyValue(val);
                    }
                    // Unit removal for number inputs
                    if (ctrl.type === 'number' || ctrl.type === 'range') {
                        val = parseFloat(val) || ''; // '16px' -> 16
                    }

                    ctrl.value = val;
                });

                // 2. Sync Buttons (Active State)
                document.querySelectorAll('.style-btn').forEach(btn => {
                    const prop = btn.dataset.styleProp;
                    const val = btn.dataset.value;
                    const current = s[prop];
                    if (current.includes(val) || (prop === 'textAlign' && current === val)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                // 3. Sync Toggles
                document.querySelectorAll('.style-toggle').forEach(btn => {
                    const prop = btn.dataset.styleProp;
                    const onVal = btn.dataset.on;
                    const current = s[prop];
                    const isActive = String(current).includes(onVal) || (onVal === 'bold' && (current === '700' || current === 'bold'));

                    if (isActive) btn.classList.add('active');
                    else btn.classList.remove('active');
                });

                // 4. Update Border UI Manually (Composite property)
                const bw = parseInt(s.borderTopWidth) || 0;
                document.getElementById('border-width').value = bw;
                document.getElementById('border-style').value = s.borderTopStyle === 'none' ? 'none' : s.borderTopStyle;
                document.getElementById('border-color').value = app.rgbToHex(s.borderTopColor);

                // 5. Visibility Controls
                const flexControls = document.getElementById('flex-controls');
                if (s.display === 'flex' || s.display === 'inline-flex') {
                    flexControls.classList.remove('hidden');
                } else {
                    flexControls.classList.add('hidden');
                }
            }
        }

        // --- Main Application Logic ---
        const app = {
            iframe: document.getElementById('content-frame'),
            doc: null,
            selectedEl: null,
            gui: null,
            historyStack: [],
            historyIndex: -1,
            MAX_HISTORY: 40,

            // Icons
            commonIcons: [
                'fa-solid fa-user', 'fa-solid fa-house', 'fa-solid fa-magnifying-glass', 'fa-solid fa-bars', 'fa-solid fa-gear',
                'fa-solid fa-check', 'fa-solid fa-xmark', 'fa-solid fa-trash', 'fa-solid fa-pen', 'fa-solid fa-image',
                'fa-solid fa-heart', 'fa-solid fa-star', 'fa-solid fa-thumbs-up', 'fa-solid fa-share', 'fa-solid fa-envelope',
                'fa-solid fa-arrow-right', 'fa-solid fa-chevron-right', 'fa-solid fa-phone', 'fa-solid fa-location-dot',
                'fa-brands fa-facebook', 'fa-brands fa-twitter', 'fa-brands fa-instagram', 'fa-brands fa-github', 'fa-brands fa-youtube'
            ],

            init: function () {
                // File Upload Listener
                document.getElementById('file-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => this.loadContent(evt.target.result);
                    reader.readAsText(file);
                });

                // Image Changer Listener
                document.getElementById('img-changer').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && this.selectedEl && this.selectedEl.tagName === 'IMG') {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            this.selectedEl.src = evt.target.result;
                            this.updateSidebarUI();
                            this.saveState();
                        };
                        reader.readAsDataURL(file);
                    }
                    e.target.value = '';
                });

                // Initialize GUI Manager
                this.gui = new GUIManager();
            },

            loadContent: function (html, isHistoryOp = false) {
                if (!html.includes('font-awesome')) {
                    const faCDN = '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">';
                    html = html.replace(/<head>/i, '<head>\n' + faCDN) || faCDN + html;
                }

                this.doc = this.iframe.contentDocument || this.iframe.contentWindow.document;
                this.doc.open();
                this.doc.write(html);
                this.doc.close();

                this.iframe.onload = () => {
                    this.doc = this.iframe.contentDocument || this.iframe.contentWindow.document;
                    this.injectEditorStyles();
                    this.enableEditing();
                    this.renderIconGrid();

                    if (!isHistoryOp) {
                        this.selectedEl = null;
                        this.updateSidebarUI();
                        setTimeout(() => this.saveState(), 100);
                    } else {
                        this.selectedEl = null;
                        this.updateSidebarUI();
                    }
                };
            },

            injectEditorStyles: function () {
                if (!this.doc) return;
                if (!this.doc.querySelector('link[href*="font-awesome"]')) {
                    const faLink = this.doc.createElement('link');
                    faLink.rel = 'stylesheet';
                    faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';
                    (this.doc.head || this.doc.body).appendChild(faLink);
                }

                if (this.doc.getElementById('visual-editor-style')) return;

                const style = this.doc.createElement('style');
                style.id = 'visual-editor-style';
                style.innerHTML = `
                    .ve-hover:hover { outline: 2px dashed #60a5fa !important; cursor: pointer; opacity: 0.95; }
                    .ve-selected { outline: 2px solid #2563eb !important; outline-offset: -2px; z-index: 9999; box-shadow: 0 0 0 4px rgba(37,99,235,0.2); }
                    a { pointer-events: none; }
                    *:empty:not(img):not(br):not(hr):not(i)::before { content: 'Empty Box'; color: #ccc; font-size: 10px; display: block; background: #f8f8f8; padding: 2px; }
                    i { cursor: pointer; caret-color: transparent; } 
                `;
                this.doc.head.appendChild(style);
            },

            enableEditing: function () {
                const allElements = this.doc.body.getElementsByTagName('*');
                const skipTags = ['SCRIPT', 'STYLE', 'LINK', 'META', 'TITLE', 'BR', 'HR'];

                for (let el of allElements) {
                    if (skipTags.includes(el.tagName)) continue;
                    el.classList.add('ve-hover');

                    if (el.tagName !== 'IMG') {
                        el.contentEditable = "true";
                        if (el.tagName === 'I') {
                            el.addEventListener('keydown', (e) => e.preventDefault());
                            el.addEventListener('paste', (e) => e.preventDefault());
                            el.addEventListener('input', (e) => e.preventDefault());
                        } else {
                            el.addEventListener('blur', () => this.saveState());
                            el.addEventListener('paste', (e) => {
                                e.preventDefault();
                                const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                                this.doc.execCommand("insertText", false, text);
                            });
                        }
                    }

                    el.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.selectElement(el);
                    };
                }

                this.doc.body.onclick = (e) => {
                    if (e.target === this.doc.body) this.selectElement(this.doc.body);
                }
            },

            selectElement: function (el) {
                if (this.selectedEl) this.selectedEl.classList.remove('ve-selected');
                this.selectedEl = el;
                this.selectedEl.classList.add('ve-selected');
                this.updateSidebarUI();
            },

            deselectAll: function (e) {
                if (e.target.id === 'editor-canvas') {
                    if (this.selectedEl) this.selectedEl.classList.remove('ve-selected');
                    this.selectedEl = null;
                    this.updateSidebarUI();
                }
            },

            updateSidebarUI: function () {
                const display = document.getElementById('selected-tag-display');
                const imgControls = document.getElementById('img-control-group');
                const iconPanel = document.getElementById('icon-panel');

                if (!this.selectedEl) {
                    display.innerText = "none";
                    imgControls.style.display = 'none';
                    iconPanel.classList.add('hidden');
                    // GUI Manager will handle disabling/resetting logic if needed
                    return;
                }

                // Tag Info
                let tagName = this.selectedEl.tagName.toLowerCase();
                if (this.selectedEl.id) tagName += `#${this.selectedEl.id}`;
                display.innerText = `<${tagName}>`;

                // Panels
                if (this.selectedEl.tagName === 'I') iconPanel.classList.remove('hidden');
                else iconPanel.classList.add('hidden');

                if (this.selectedEl.tagName === 'IMG') {
                    imgControls.style.display = 'block';
                    document.getElementById('input-src').value = this.selectedEl.getAttribute('src');
                } else {
                    imgControls.style.display = 'none';
                }

                // Advanced
                document.getElementById('input-classes').value = this.selectedEl.className.replace('ve-hover', '').replace('ve-selected', '').trim();
                document.getElementById('input-html').value = this.selectedEl.outerHTML;

                // ★ GUI Manager Sync Call ★
                this.gui.syncUI(this.selectedEl);
            },

            // --- History System ---
            saveState: function () {
                if (!this.doc) return;
                const style = this.doc.getElementById('visual-editor-style');
                if (style) style.remove();
                const selected = this.doc.querySelector('.ve-selected');
                if (selected) selected.classList.remove('ve-selected');

                const html = this.doc.documentElement.outerHTML;

                this.injectEditorStyles();
                if (this.selectedEl && this.doc.contains(this.selectedEl)) {
                    this.selectedEl.classList.add('ve-selected');
                }

                if (this.historyIndex < this.historyStack.length - 1) {
                    this.historyStack = this.historyStack.slice(0, this.historyIndex + 1);
                }
                this.historyStack.push(html);
                this.historyIndex++;
                if (this.historyStack.length > this.MAX_HISTORY) {
                    this.historyStack.shift();
                    this.historyIndex--;
                }
            },

            undo: function () {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.loadContent(this.historyStack[this.historyIndex], true);
                }
            },

            redo: function () {
                if (this.historyIndex < this.historyStack.length - 1) {
                    this.historyIndex++;
                    this.loadContent(this.historyStack[this.historyIndex], true);
                }
            },

            // --- Style Actions ---
            applyStyle: function (prop, value) {
                if (!this.selectedEl) return;
                this.selectedEl.style[prop] = value;
                this.saveState();
            },

            toggleStyle: function (prop, valOn, valOff) {
                if (!this.selectedEl) return;
                const current = window.getComputedStyle(this.selectedEl)[prop];
                const isSet = String(current).includes(valOn) || (valOn === 'bold' && current === '700');
                this.selectedEl.style[prop] = isSet ? valOff : valOn;
                this.updateSidebarUI();
                this.saveState();
            },

            applyAttribute: function (attr, value) {
                if (!this.selectedEl) return;
                this.selectedEl.setAttribute(attr, value);
                this.saveState();
            },

            applyClasses: function (value) {
                if (!this.selectedEl) return;
                const internalClasses = ['ve-hover', 've-selected'];
                this.selectedEl.className = value + ' ' + internalClasses.join(' ');
                this.saveState();
            },

            // --- Icon Logic ---
            renderIconGrid: function (filter = '') {
                const container = document.getElementById('icon-grid-container');
                container.innerHTML = '';
                const filtered = this.commonIcons.filter(c => c.includes(filter.toLowerCase()));
                filtered.forEach(iconClass => {
                    const btn = document.createElement('div');
                    btn.className = 'icon-btn';
                    btn.innerHTML = `<i class="${iconClass}"></i>`;
                    btn.onclick = () => this.applyIcon(iconClass);
                    container.appendChild(btn);
                });
            },

            applyIcon: function (newClass) {
                if (!this.selectedEl || this.selectedEl.tagName !== 'I') return;
                const internalClasses = ['ve-hover', 've-selected'];
                this.selectedEl.className = newClass + ' ' + internalClasses.join(' ');
                this.updateSidebarUI();
                this.saveState();
            },

            // --- Misc Utils ---
            selectParent: function () {
                if (this.selectedEl && this.selectedEl.parentElement && this.selectedEl.parentElement !== this.doc.documentElement) {
                    this.selectElement(this.selectedEl.parentElement);
                }
            },

            deleteSelected: function () {
                if (!this.selectedEl) return;
                if (confirm('삭제하시겠습니까?')) {
                    this.selectedEl.remove();
                    this.selectedEl = null;
                    this.updateSidebarUI();
                    this.saveState();
                }
            },

            cloneSelected: function () {
                if (!this.selectedEl) return;
                const clone = this.selectedEl.cloneNode(true);
                clone.classList.remove('ve-selected');
                this.selectedEl.insertAdjacentElement('afterend', clone);
                this.saveState();
                this.enableEditing();
            },

            toggleHtmlEdit: function () {
                document.getElementById('input-html').classList.toggle('hidden');
            },

            applyOuterHTML: function (value) {
                if (!this.selectedEl) return;
                try {
                    const temp = this.doc.createElement('div');
                    temp.innerHTML = value;
                    const newEl = temp.firstElementChild;
                    if (!newEl) return;
                    this.selectedEl.replaceWith(newEl);
                    this.selectedEl = newEl;
                    this.injectEditorStyles();
                    this.enableEditing();
                    this.selectElement(this.selectedEl);
                    this.saveState();
                } catch (e) { alert("HTML 오류"); }
            },

            saveHTML: function () {
                if (!this.doc) return;
                const style = this.doc.getElementById('visual-editor-style');
                if (style) style.remove();
                const selected = this.doc.querySelector('.ve-selected');
                if (selected) selected.classList.remove('ve-selected');
                const hovers = this.doc.querySelectorAll('.ve-hover');
                hovers.forEach(el => el.classList.remove('ve-hover'));
                const editables = this.doc.querySelectorAll('[contenteditable]');
                editables.forEach(el => el.removeAttribute('contenteditable'));

                const htmlContent = this.doc.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: "text/html" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "edited_page_v04.html";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.injectEditorStyles();
                this.enableEditing();
                if (selected) selected.classList.add('ve-selected');
            },

            setDevice: function (type) {
                this.iframe.className = type;
            },

            rgbToHex: function (rgb) {
                if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
                if (rgb.startsWith('#')) return rgb;
                const rgbValues = rgb.match(/\d+/g);
                if (!rgbValues) return '#000000';
                return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1);
            },

            getFontFamilyValue: function (val) {
                if (!val) return "";
                if (val.includes('Jua')) return "'Jua', sans-serif";
                if (val.includes('Comfortaa')) return "'Comfortaa', cursive";
                if (val.includes('sans-serif')) return "sans-serif";
                if (val.includes('serif')) return "serif";
                if (val.includes('monospace')) return "monospace";
                return "";
            }
        };

        // --- Init ---
        window.onload = function () {
            app.init();

            // 데모 로드
            const demoHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body{display:flex;justify-content:center;align-items:center;height:100vh;font-family:'Jua',sans-serif;background:#fff0f6;margin:0;} 
        .card{background:white;padding:50px;border-radius:40px;box-shadow:0 20px 50px rgba(255, 118, 117, 0.2);text-align:center;width:400px;border:8px solid #fff;}
        h1{color:#a29bfe;font-size:48px;margin:0 0 20px 0;text-shadow:2px 2px 0 #dfe6e9;}
        p{color:#636e72;font-size:20px;line-height:1.6;}
        .btn{background:#74b9ff;color:white;padding:15px 30px;font-size:24px;border-radius:50px;border:none;margin-top:30px;display:inline-block;box-shadow:0 10px 20px rgba(116, 185, 255, 0.4);}
        i.icon-demo { font-size: 60px; color: #ff7675; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <i class="fa-solid fa-wand-magic-sparkles icon-demo"></i>
        <h1>GUIManager v0.04</h1>
        <p>이제 코드 구조가<br><strong>이벤트 기반</strong>으로 변경되었습니다.<br>더 쉽고 강력하게 확장하세요!</p>
        <button class="btn">시작하기</button>
    </div>
</body>
</html>`;
            app.loadContent(demoHTML);
        }
    </script>
</body>

</html>