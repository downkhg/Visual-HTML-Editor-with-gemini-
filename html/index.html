<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ì£¼ì–¼ HTML ì—ë””í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* ì—ë””í„° UI ìŠ¤íƒ€ì¼ (í¸ì§‘ ëŒ€ìƒ HTMLê³¼ ì„ì´ì§€ ì•Šë„ë¡ ì ‘ë‘ì‚¬ ì‚¬ìš©) */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        #app-container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 280px;
            background-color: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            z-index: 10;
        }

        #editor-canvas {
            flex: 1;
            background-color: #f1f5f9;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
        }

        /* ì‹¤ì œ ì½˜í…ì¸ ê°€ ë“¤ì–´ê°ˆ ì•„ì´í”„ë ˆì„ */
        #content-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: width 0.3s;
        }

        /* ë””ë°”ì´ìŠ¤ ë·° ëª¨ë“œ */
        #content-frame.mobile {
            width: 375px;
            height: 667px;
        }

        #content-frame.tablet {
            width: 768px;
            height: 1024px;
        }

        #content-frame.desktop {
            width: 100%;
            height: 100%;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            width: 100%;
            text-align: left;
            border-radius: 6px;
            transition: all 0.2s;
            color: #94a3b8;
        }

        .tool-btn:hover {
            background-color: #334155;
            color: white;
        }

        .tool-btn.active {
            background-color: #2563eb;
            color: white;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            font-weight: bold;
            margin: 20px 0 10px 16px;
        }
    </style>
</head>

<body>

    <div id="app-container">
        <!-- ì‚¬ì´ë“œë°”: íˆ´ë°” -->
        <aside id="sidebar" class="p-4">
            <div class="flex items-center gap-3 mb-8 px-2">
                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center font-bold text-white">E</div>
                <h1 class="font-bold text-lg">Visual Editor</h1>
            </div>

            <div class="section-title">íŒŒì¼</div>
            <button onclick="document.getElementById('file-upload').click()" class="tool-btn">
                <i class="fa-solid fa-folder-open"></i> HTML ì—´ê¸°
            </button>
            <input type="file" id="file-upload" accept=".html,.htm" hidden>

            <button onclick="saveHTML()" class="tool-btn text-green-400 hover:text-green-300">
                <i class="fa-solid fa-download"></i> HTML ì €ì¥ (ë‹¤ìš´ë¡œë“œ)
            </button>

            <div class="section-title">í¸ì§‘ ë„êµ¬</div>
            <button id="btn-edit-mode" onclick="toggleEditMode()" class="tool-btn active">
                <i class="fa-solid fa-pen-nib"></i> í¸ì§‘ ëª¨ë“œ (ON)
            </button>
            <button onclick="injectImageHandler()" class="tool-btn">
                <i class="fa-regular fa-image"></i> ì´ë¯¸ì§€ êµì²´ ê¸°ëŠ¥ ì¬ì—°ê²°
            </button>

            <div class="section-title">ë·° ëª¨ë“œ</div>
            <div class="flex gap-2 px-2">
                <button onclick="setDevice('desktop')"
                    class="p-2 bg-slate-700 rounded hover:bg-slate-600 text-white flex-1"><i
                        class="fa-solid fa-desktop"></i></button>
                <button onclick="setDevice('tablet')"
                    class="p-2 bg-slate-700 rounded hover:bg-slate-600 text-white flex-1"><i
                        class="fa-solid fa-tablet-screen-button"></i></button>
                <button onclick="setDevice('mobile')"
                    class="p-2 bg-slate-700 rounded hover:bg-slate-600 text-white flex-1"><i
                        class="fa-solid fa-mobile-screen-button"></i></button>
            </div>

            <div class="mt-auto pt-4 text-xs text-slate-500 px-2">
                <p>íŒ: í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”.<br>ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ êµì²´í•˜ì„¸ìš”.</p>
            </div>
        </aside>

        <!-- ë©”ì¸ ìº”ë²„ìŠ¤ -->
        <main id="editor-canvas">
            <iframe id="content-frame" class="desktop"></iframe>
        </main>
    </div>

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œìš© íˆë“  ì¸í’‹ -->
    <input type="file" id="img-changer" accept="image/*" hidden>

    <script>
        const iframe = document.getElementById('content-frame');
        let doc = null; // iframe document
        let isEditMode = true;
        let currentTargetImg = null;

        // 1. íŒŒì¼ ì—´ê¸°
        document.getElementById('file-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const htmlContent = event.target.result;
                loadContent(htmlContent);
            };
            reader.readAsText(file);
        });

        function loadContent(html) {
            // iframeì— ë‚´ìš© ì“°ê¸°
            doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            // ë¡œë“œ ì™„ë£Œ í›„ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì…
            iframe.onload = function () {
                doc = iframe.contentDocument || iframe.contentWindow.document;
                injectEditorStyles();
                if (isEditMode) enableEditing();
            };
        }

        // 2. í¸ì§‘ ê¸°ëŠ¥ í™œì„±í™” (ë§¤ì§ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì…)
        function injectEditorStyles() {
            if (!doc) return;
            const style = doc.createElement('style');
            style.id = 'visual-editor-style';
            style.innerHTML = `
                .ve-editable-text:hover {
                    outline: 2px dashed #3b82f6 !important;
                    background-color: rgba(59, 130, 246, 0.1);
                    cursor: text;
                }
                .ve-editable-img:hover {
                    outline: 3px solid #ef4444 !important;
                    cursor: pointer;
                    opacity: 0.8;
                }
                /* ë§í¬ ì´ë™ ë°©ì§€ */
                a.ve-disabled { pointer-events: none; }
            `;
            doc.head.appendChild(style);
        }

        function enableEditing() {
            if (!doc) return;
            isEditMode = true;
            updateEditBtn();

            // ëª¨ë“  ì‹œê°ì  ìš”ì†Œì— ëŒ€í•´ ë°˜ë³µ
            const allElements = doc.body.getElementsByTagName('*');
            const nonEditableTags = ['SCRIPT', 'STYLE', 'LINK', 'META', 'TITLE', 'BR', 'HR'];

            for (let el of allElements) {
                if (nonEditableTags.includes(el.tagName)) {
                    continue;
                }

                // --- 1. í…ìŠ¤íŠ¸ ë° ì¼ë°˜ ì½˜í…ì¸  í¸ì§‘ í™œì„±í™” ---
                // ëª¨ë“  ë¸”ë¡/ì¸ë¼ì¸ ìš”ì†Œë¥¼ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
                // í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ëª¨ë“  ì¼ë°˜ì ì¸ ìš”ì†Œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
                if (el.tagName !== 'IMG') { // ì´ë¯¸ì§€ëŠ” ì•„ë˜ì—ì„œ ë³„ë„ ì²˜ë¦¬
                    el.contentEditable = "true";
                    el.classList.add('ve-editable-text');
                }

                // --- 2. ì´ë¯¸ì§€ ë° ì•„ì´ì½˜ ì²˜ë¦¬ ---
                // ì´ë¯¸ì§€ ì²˜ë¦¬: ê¸°ì¡´ <img> íƒœê·¸
                if (el.tagName === 'IMG') {
                    el.classList.add('ve-editable-img');
                    // ê¸°ì¡´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
                    el.onclick = function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!isEditMode) return;

                        // ë¶€ëª¨ì°½(ì´ íŒŒì¼)ì˜ ì´ë¯¸ì§€ ì—…ë¡œë” ì‹¤í–‰
                        currentTargetImg = el;
                        document.getElementById('img-changer').click();
                    };
                }

                // FontAwesome ì•„ì´ì½˜ ì²˜ë¦¬: ì•„ì´ì½˜ë„ í…ìŠ¤íŠ¸ í¸ì§‘ìœ¼ë¡œ í´ë˜ìŠ¤ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ìœ ì§€
                if (el.tagName === 'I' && el.classList.contains('fa-solid') || el.classList.contains('fa-regular')) {
                    // ì´ë¯¸ ìœ„ì—ì„œ contentEditable=trueê°€ ì„¤ì •ë˜ì—ˆì„ ê²ƒ
                    // íŠ¹ë³„í•œ ì´ë¯¸ì§€ êµì²´ ë¡œì§ì€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ í…ìŠ¤íŠ¸ì²˜ëŸ¼ í´ë˜ìŠ¤ í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë‘ 
                    el.title = "ì•„ì´ì½˜ í´ë˜ìŠ¤ë¥¼ ìˆ˜ì •í•˜ì„¸ìš” (ì˜ˆ: fa-pencil)"; // íŒ ì œê³µ
                }

                // --- 3. ë§í¬ ì´ë™ ë°©ì§€ ---
                if (el.tagName === 'A') {
                    el.classList.add('ve-disabled');
                    el.onclick = (e) => { if (isEditMode) e.preventDefault(); };
                }
            }

            // ë°°ê²½ìƒ‰/ë°°ê²½ ì´ë¯¸ì§€ í¸ì§‘ì„ ìœ„í•œ ì¶”ê°€ ê¸°ëŠ¥ (ì„ íƒì )
            // body ìì²´ë¥¼ í´ë¦­í•˜ë©´ í˜„ì¬ í˜ì´ì§€ì˜ ë°°ê²½ìƒ‰ì„ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ (ê³ ê¸‰ ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¥˜)
            if (doc.body && !doc.body.dataset.backgroundListener) {
                doc.body.dataset.backgroundListener = 'true';
                doc.body.addEventListener('contextmenu', function (e) {
                    if (isEditMode && e.target === doc.body) {
                        e.preventDefault();
                        const newColor = prompt("ë°°ê²½ìƒ‰ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: #f0f9ff ë˜ëŠ” red):", doc.body.style.backgroundColor || doc.defaultView.getComputedStyle(doc.body).backgroundColor);
                        if (newColor !== null) {
                            doc.body.style.backgroundColor = newColor;
                        }
                    }
                });
            }
        }

        function disableEditing() {
            if (!doc) return;
            isEditMode = false;
            updateEditBtn();

            const editables = doc.querySelectorAll('[contenteditable]');
            editables.forEach(el => {
                el.removeAttribute('contenteditable');
                el.classList.remove('ve-editable-text');
            });

            const images = doc.querySelectorAll('.ve-editable-img');
            images.forEach(el => {
                el.classList.remove('ve-editable-img');
                el.onclick = null; // ì´ë²¤íŠ¸ ì œê±°
            });

            const links = doc.querySelectorAll('.ve-disabled');
            links.forEach(el => el.classList.remove('ve-disabled'));
        }

        function toggleEditMode() {
            if (isEditMode) disableEditing();
            else enableEditing();
        }

        function updateEditBtn() {
            const btn = document.getElementById('btn-edit-mode');
            if (isEditMode) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-pen-nib"></i> í¸ì§‘ ëª¨ë“œ (ON)';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-solid fa-eye"></i> ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œ';
            }
        }

        // 3. ì´ë¯¸ì§€ êµì²´ ë¡œì§
        document.getElementById('img-changer').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file && currentTargetImg) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    currentTargetImg.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
            this.value = ''; // ì´ˆê¸°í™”
        });

        // ê°€ë” ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œ ë•Œë¬¸ì— í•¸ë“¤ëŸ¬ê°€ ëŠê¸°ë©´ ìˆ˜ë™ ì—°ê²°
        function injectImageHandler() {
            enableEditing(); // ë‹¤ì‹œ ì‹¤í–‰í•´ì„œ ì¬ì—°ê²°
        }

        // 4. ì €ì¥ (ë‹¤ìš´ë¡œë“œ)
        function saveHTML() {
            if (!doc) {
                alert("ì €ì¥í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì €ì¥ ì „ í´ë¦°ì—…: ì—ë””í„°ìš© í´ë˜ìŠ¤ì™€ ìŠ¤íƒ€ì¼ ì œê±°
            const wasEditMode = isEditMode;
            disableEditing(); // í¸ì§‘ ëª¨ë“œ ë„ê¸° (ì†ì„± ì œê±°)

            // ì£¼ì…í–ˆë˜ ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
            const styleTag = doc.getElementById('visual-editor-style');
            if (styleTag) styleTag.remove();

            // HTML ë¬¸ìì—´ ì¶”ì¶œ
            const htmlContent = doc.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = "edited_page.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // ë‹¤ì‹œ í¸ì§‘ ëª¨ë“œ ë³µêµ¬
            injectEditorStyles(); // ìŠ¤íƒ€ì¼ ë‹¤ì‹œ ì£¼ì…
            if (wasEditMode) enableEditing();
        }

        // 5. ë·° ëª¨ë“œ ë³€ê²½
        function setDevice(type) {
            iframe.className = type;
        }

        // ì´ˆê¸° ë°ëª¨ ë¡œë“œ (ì‚¬ìš©ìê°€ ë°”ë¡œ ëŠë‚Œì„ ì•Œ ìˆ˜ ìˆë„ë¡ ì ¤ë¦¬ PPT ì½”ë“œ ë¡œë“œ)
        window.onload = function () {
            // ì•ì„œ ë§Œë“  Jelly PPT ì½”ë“œë¥¼ ê¸°ë³¸ ì˜ˆì œë¡œ ë¡œë“œí•´ë´…ë‹ˆë‹¤. (ì‹¤ì œ í™˜ê²½ì—ì„  ë¹ˆ í™”ë©´ì´ê±°ë‚˜ ë„ì›€ë§ì´ ëœ¸)
            const demoHTML = `
                <!DOCTYPE html>
                <html lang="ko">
                <head><style>body{display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;background:#f0f9ff;text-align:center;} h1{color:#0284c7;}</style></head>
                <body>
                    <div>
                        <h1>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h1>
                        <p>ì™¼ìª½ ë©”ë‰´ì˜ [HTML ì—´ê¸°]ë¥¼ ëˆŒëŸ¬ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
                        <p>ë˜ëŠ” ì´ í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•´ì„œ ë°”ë¡œ ìˆ˜ì •í•´ë³´ì„¸ìš”.</p>
                        <br>
                        <img src="https://placehold.co/100x100?text=IMG" style="border-radius:50%">
                        <p><small>ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ êµì²´ë©ë‹ˆë‹¤.</small></p>
                    </div>
                </body>
                </html>
             `;
            loadContent(demoHTML);
        }

    </script>
</body>

</html>