<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual HTML Editor v0.02</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- ÏóêÎîîÌÑ∞ UI Ïä§ÌÉÄÏùº (Ìé∏Ïßë ÎåÄÏÉÅÍ≥º Î∂ÑÎ¶¨) --- */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Pretendard', sans-serif;
        }

        /* Î†àÏù¥ÏïÑÏõÉ */
        #app-container {
            display: flex;
            height: 100vh;
            background-color: #0f172a;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        #sidebar {
            width: 340px;
            /* Ìå®ÎÑê ÌôïÏû• */
            background-color: #1e293b;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            z-index: 20;
            overflow-y: auto;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïª§Ïä§ÌÖÄ */
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 3px;
        }

        /* Î©îÏù∏ ÏòÅÏó≠ */
        #editor-canvas {
            flex: 1;
            background-color: #cbd5e1;
            /* Ï∫îÎ≤ÑÏä§ Î∞∞Í≤Ω */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            overflow: auto;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* ÏïÑÏù¥ÌîÑÎ†àÏûÑ (Ìé∏Ïßë ÌôîÎ©¥) */
        #content-frame {
            background: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #content-frame.mobile {
            width: 375px;
            height: 667px;
            border-radius: 20px;
            border: 8px solid #333;
        }

        #content-frame.tablet {
            width: 768px;
            height: 1024px;
            border-radius: 12px;
            border: 8px solid #333;
        }

        #content-frame.desktop {
            width: 100%;
            height: 100%;
            border-radius: 0;
            border: none;
        }

        /* UI Ïª¥Ìè¨ÎÑåÌä∏ */
        .panel-section {
            padding: 16px;
            border-bottom: 1px solid #334155;
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            letter-spacing: 0.05em;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 8px;
        }

        .control-label {
            font-size: 0.75rem;
            color: #cbd5e1;
            white-space: nowrap;
        }

        /* Inputs */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #475569;
            border-radius: 4px;
        }

        input[type="range"] {
            width: 100%;
            accent-color: #3b82f6;
            height: 4px;
            border-radius: 2px;
        }

        /* Buttons */
        .btn {
            background-color: #334155;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            background-color: #475569;
        }

        .btn.primary {
            background-color: #2563eb;
        }

        .btn.primary:hover {
            background-color: #1d4ed8;
        }

        .btn.danger {
            background-color: #ef4444;
            color: white;
        }

        .btn.active {
            background-color: #3b82f6;
            color: white;
            border: 1px solid #60a5fa;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon {
            padding: 6px;
            width: 32px;
            height: 32px;
        }

        .btn-group {
            display: flex;
            gap: 1px;
            background: #334155;
            padding: 2px;
            border-radius: 4px;
        }

        .btn-group .btn {
            flex: 1;
            background: transparent;
            padding: 4px;
            height: 28px;
        }

        .btn-group .btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-group .btn.active {
            background: #2563eb;
        }
    </style>
</head>

<body>

    <div id="app-container">
        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <aside id="sidebar">
            <!-- 1. Ìó§Îçî & ÌååÏùº Í¥ÄÎ¶¨ -->
            <div class="panel-section bg-slate-900 sticky top-0 z-10">
                <div class="flex items-center gap-3 mb-4">
                    <div
                        class="w-8 h-8 bg-indigo-500 rounded flex items-center justify-center font-bold text-white text-xs shadow-lg">
                        V.02</div>
                    <h1 class="font-bold text-sm">Visual Editor v0.02</h1>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="document.getElementById('file-upload').click()" class="btn flex-1"><i
                            class="fa-solid fa-folder-open"></i> Ïó¥Í∏∞</button>
                    <button onclick="saveHTML()" class="btn flex-1 text-green-400"><i class="fa-solid fa-download"></i>
                        Ï†ÄÏû•</button>
                </div>
                <input type="file" id="file-upload" accept=".html,.htm" hidden>

                <div class="flex gap-2">
                    <button onclick="undo()" class="btn flex-1 text-yellow-400" title="Ctrl+Z"><i
                            class="fa-solid fa-rotate-left"></i> Undo</button>
                    <button onclick="redo()" class="btn flex-1 text-yellow-400" title="Ctrl+Y"><i
                            class="fa-solid fa-rotate-right"></i> Redo</button>
                </div>
            </div>

            <!-- 2. ÏÑ†ÌÉùÎêú ÏöîÏÜå Ï†ïÎ≥¥ -->
            <div class="panel-section border-b border-slate-700 bg-slate-800/50">
                <div class="section-title">
                    <span>Selection</span>
                    <span id="selected-tag-display" class="text-xs text-blue-300 font-mono">none</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="selectParent()" class="btn btn-icon flex-1" title="Î∂ÄÎ™® ÏÑ†ÌÉù (UP)"><i
                            class="fa-solid fa-arrow-up"></i></button>
                    <button onclick="cloneSelected()" class="btn btn-icon flex-1" title="Î≥µÏ†ú"><i
                            class="fa-regular fa-clone"></i></button>
                    <button onclick="deleteSelected()" class="btn btn-icon flex-1 danger" title="ÏÇ≠Ï†ú"><i
                            class="fa-solid fa-trash"></i></button>
                </div>
            </div>

            <!-- 3. Typography (ÌôïÏû•Îê®) -->
            <div class="panel-section">
                <div class="section-title">Typography (Î¨∏Ïûê)</div>

                <div class="mb-2">
                    <label class="control-label block mb-1">Ìè∞Ìä∏ (Font Family)</label>
                    <select id="input-font-family" onchange="applyStyle('fontFamily', this.value)">
                        <option value="">Í∏∞Î≥∏ (Inherit)</option>
                        <option value="'Jua', sans-serif">Jua (Îë•Í∑ºÏ≤¥)</option>
                        <option value="'Comfortaa', cursive">Comfortaa (ÏòÅÎ¨∏ Îë•Í∑ºÏ≤¥)</option>
                        <option value="sans-serif">Sans Serif (Í≥†Îîï)</option>
                        <option value="serif">Serif (Î™ÖÏ°∞)</option>
                        <option value="monospace">Monospace (ÏΩîÎî©)</option>
                    </select>
                </div>

                <div class="control-row">
                    <span class="control-label">ÏÉâÏÉÅ</span>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <span id="text-color-val" class="text-xs text-slate-400">#000000</span>
                        <input type="color" id="input-color" onchange="applyStyle('color', this.value)">
                    </div>
                </div>

                <div class="control-grid mb-2">
                    <div>
                        <label class="control-label block mb-1">ÌÅ¨Í∏∞ (px)</label>
                        <input type="number" id="input-font-size" onchange="applyStyle('fontSize', this.value + 'px')">
                    </div>
                    <div>
                        <label class="control-label block mb-1">Ï§Ñ Í∞ÑÍ≤©</label>
                        <input type="number" step="0.1" id="input-line-height"
                            onchange="applyStyle('lineHeight', this.value)">
                    </div>
                </div>

                <div class="btn-group mb-2">
                    <button onclick="applyStyle('textAlign', 'left')" class="btn" id="btn-align-left"><i
                            class="fa-solid fa-align-left"></i></button>
                    <button onclick="applyStyle('textAlign', 'center')" class="btn" id="btn-align-center"><i
                            class="fa-solid fa-align-center"></i></button>
                    <button onclick="applyStyle('textAlign', 'right')" class="btn" id="btn-align-right"><i
                            class="fa-solid fa-align-right"></i></button>
                    <button onclick="applyStyle('textAlign', 'justify')" class="btn" id="btn-align-justify"><i
                            class="fa-solid fa-align-justify"></i></button>
                </div>

                <div class="btn-group">
                    <button onclick="toggleStyle('fontWeight', 'bold', 'normal')" class="btn" id="btn-bold"><i
                            class="fa-solid fa-bold"></i></button>
                    <button onclick="toggleStyle('fontStyle', 'italic', 'normal')" class="btn" id="btn-italic"><i
                            class="fa-solid fa-italic"></i></button>
                    <button onclick="toggleStyle('textDecoration', 'underline', 'none')" class="btn"
                        id="btn-underline"><i class="fa-solid fa-underline"></i></button>
                </div>
            </div>

            <!-- 4. Layout (Flex Ï∂îÍ∞Ä) -->
            <div class="panel-section">
                <div class="section-title">Layout & Spacing</div>

                <div class="mb-2">
                    <label class="control-label block mb-1">Î∞∞Ïπò Î∞©Ïãù (Display)</label>
                    <select id="input-display" onchange="applyStyle('display', this.value); updateSidebarUI();">
                        <option value="block">Block</option>
                        <option value="flex">Flex (Ï†ïÎ†¨ Ïª®ÌÖåÏù¥ÎÑà)</option>
                        <option value="inline">Inline</option>
                        <option value="inline-block">Inline-Block</option>
                        <option value="grid">Grid</option>
                        <option value="none">None (Ïà®ÍπÄ)</option>
                    </select>
                </div>

                <!-- Flex Controls (Ï°∞Í±¥Î∂Ä ÌëúÏãú) -->
                <div id="flex-controls" class="bg-slate-800 p-2 rounded mb-2 hidden">
                    <label class="control-label block mb-1 text-blue-300">Flex Ï†ïÎ†¨</label>
                    <div class="control-row">
                        <span class="control-label text-xs">Í∞ÄÎ°ú</span>
                        <select id="input-justify" class="text-xs" onchange="applyStyle('justifyContent', this.value)">
                            <option value="flex-start">ÏãúÏûë (Left)</option>
                            <option value="center">Ï§ëÏïô (Center)</option>
                            <option value="flex-end">ÎÅù (Right)</option>
                            <option value="space-between">ÏñëÎÅù (Between)</option>
                            <option value="space-around">Í∑†Îì± (Around)</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label text-xs">ÏÑ∏Î°ú</span>
                        <select id="input-align" class="text-xs" onchange="applyStyle('alignItems', this.value)">
                            <option value="stretch">Ï±ÑÏö∞Í∏∞ (Stretch)</option>
                            <option value="flex-start">ÏÉÅÎã® (Top)</option>
                            <option value="center">Ï§ëÏïô (Middle)</option>
                            <option value="flex-end">ÌïòÎã® (Bottom)</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <span class="control-label text-xs">Í∞ÑÍ≤© (Gap)</span>
                        <input type="text" id="input-gap" placeholder="10px" class="text-xs"
                            onchange="applyStyle('gap', this.value)">
                    </div>
                </div>

                <div class="control-grid">
                    <div>
                        <label class="control-label block mb-1">Pad</label>
                        <input type="text" id="input-padding" placeholder="10px"
                            onchange="applyStyle('padding', this.value)">
                    </div>
                    <div>
                        <label class="control-label block mb-1">Margin</label>
                        <input type="text" id="input-margin" placeholder="0 auto"
                            onchange="applyStyle('margin', this.value)">
                    </div>
                    <div>
                        <label class="control-label block mb-1">W</label>
                        <input type="text" id="input-width" placeholder="100%"
                            onchange="applyStyle('width', this.value)">
                    </div>
                    <div>
                        <label class="control-label block mb-1">H</label>
                        <input type="text" id="input-height" placeholder="auto"
                            onchange="applyStyle('height', this.value)">
                    </div>
                </div>
            </div>

            <!-- 5. Decoration (Ïã†Í∑ú) -->
            <div class="panel-section">
                <div class="section-title">Decoration (Íæ∏ÎØ∏Í∏∞)</div>

                <div class="control-row">
                    <span class="control-label">Î∞∞Í≤ΩÏÉâ</span>
                    <div class="flex gap-2 items-center flex-1 justify-end">
                        <span id="bg-color-val" class="text-xs text-slate-400">none</span>
                        <input type="color" id="input-bg-color" onchange="applyStyle('backgroundColor', this.value)">
                    </div>
                </div>

                <div class="mb-3">
                    <div class="control-row">
                        <label class="control-label">Îë•Í∑º Î™®ÏÑúÎ¶¨ (Radius)</label>
                        <span id="radius-val" class="text-xs text-blue-300">0px</span>
                    </div>
                    <input type="range" id="input-radius" min="0" max="100" value="0"
                        oninput="applyStyle('borderRadius', this.value + 'px'); document.getElementById('radius-val').innerText = this.value + 'px'">
                </div>

                <div class="mb-3">
                    <label class="control-label block mb-1">ÌÖåÎëêÎ¶¨ (Border)</label>
                    <div class="flex gap-1">
                        <input type="number" id="input-border-width" placeholder="px" style="width: 50px"
                            onchange="updateBorder()">
                        <select id="input-border-style" onchange="updateBorder()">
                            <option value="none">ÏóÜÏùå</option>
                            <option value="solid">Ïã§ÏÑ†</option>
                            <option value="dashed">Ï†êÏÑ†</option>
                            <option value="dotted">ÎèÑÌä∏</option>
                        </select>
                        <input type="color" id="input-border-color" value="#000000" onchange="updateBorder()">
                    </div>
                </div>

                <div class="mb-1">
                    <label class="control-label block mb-1">Í∑∏Î¶ºÏûê (Shadow)</label>
                    <div class="btn-group">
                        <button onclick="applyStyle('boxShadow', 'none')" class="btn flex-1 text-xs">X</button>
                        <button onclick="applyStyle('boxShadow', '0 2px 5px rgba(0,0,0,0.1)')"
                            class="btn flex-1 text-xs">ÏïΩ</button>
                        <button onclick="applyStyle('boxShadow', '0 10px 20px rgba(0,0,0,0.15)')"
                            class="btn flex-1 text-xs">Ï§ë</button>
                        <button onclick="applyStyle('boxShadow', '0 20px 50px rgba(0,0,0,0.25)')"
                            class="btn flex-1 text-xs">Í∞ï</button>
                        <button onclick="applyStyle('boxShadow', '0 0 15px rgba(255, 255, 255, 0.8)')"
                            class="btn flex-1 text-xs"><i class="fa-solid fa-sun"></i></button>
                    </div>
                </div>
            </div>

            <!-- 6. Advanced -->
            <div class="panel-section">
                <div class="section-title">Advanced</div>

                <div class="mb-2" id="img-control-group" style="display:none;">
                    <label class="control-label block mb-1">Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§ (SRC)</label>
                    <div class="flex gap-1">
                        <input type="text" id="input-src" class="text-xs" onchange="applyAttribute('src', this.value)">
                        <button onclick="document.getElementById('img-changer').click()" class="btn btn-icon"><i
                                class="fa-regular fa-image"></i></button>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="control-label block mb-1">Classes</label>
                    <input type="text" id="input-classes" onchange="applyClasses(this.value)">
                </div>

                <div>
                    <button onclick="toggleHtmlEdit()" class="btn w-full text-xs mb-1">Raw HTML Ìé∏Ïßë <i
                            class="fa-solid fa-code ml-1"></i></button>
                    <textarea id="input-html" rows="4" class="font-mono text-xs hidden"
                        onchange="applyOuterHTML(this.value)"></textarea>
                </div>
            </div>

            <div class="mt-auto panel-section bg-slate-900 border-t border-slate-700">
                <div class="flex gap-2">
                    <button onclick="setDevice('desktop')" class="btn flex-1" title="PC"><i
                            class="fa-solid fa-desktop"></i></button>
                    <button onclick="setDevice('tablet')" class="btn flex-1" title="Tablet"><i
                            class="fa-solid fa-tablet-screen-button"></i></button>
                    <button onclick="setDevice('mobile')" class="btn flex-1" title="Mobile"><i
                            class="fa-solid fa-mobile-screen-button"></i></button>
                </div>
            </div>
        </aside>

        <!-- Î©îÏù∏ Ï∫îÎ≤ÑÏä§ -->
        <main id="editor-canvas" onclick="deselectAll(event)">
            <iframe id="content-frame" class="desktop"></iframe>
        </main>
    </div>

    <input type="file" id="img-changer" accept="image/*" hidden>

    <script>
        const iframe = document.getElementById('content-frame');
        let doc = null;
        let isEditMode = true;
        let selectedEl = null;

        // --- Undo/Redo ---
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 40;

        function saveState() {
            if (!doc) return;
            const style = doc.getElementById('visual-editor-style');
            if (style) style.remove();

            const selected = doc.querySelector('.ve-selected');
            if (selected) selected.classList.remove('ve-selected');

            const html = doc.documentElement.outerHTML;

            injectEditorStyles();
            if (selectedEl && doc.contains(selectedEl)) {
                selectedEl.classList.add('ve-selected');
            }

            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            historyStack.push(html);
            historyIndex++;
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                loadContent(historyStack[historyIndex], true);
            }
        }

        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                loadContent(historyStack[historyIndex], true);
            }
        }

        // --- Core ---
        document.getElementById('file-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => loadContent(e.target.result);
            reader.readAsText(file);
        });

        // üü¢ FIX: Font Awesome Í∞ïÏ†ú Ï£ºÏûÖ Î°úÏßÅ Í∞úÏÑ†
        function loadContent(html, isHistoryOp = false) {
            // Î∂àÎü¨Ïò§Îäî HTML Î¨∏ÏûêÏó¥Ïóê Font AwesomeÏù¥ ÏóÜÎã§Î©¥ Í∞ïÏ†úÎ°ú <head>Ïóê Ï£ºÏûÖ
            if (!html.includes('font-awesome')) {
                const faCDN = '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">';

                // Head ÌÉúÍ∑∏Í∞Ä ÏûàÏúºÎ©¥ Í∑∏ ÏïàÏóê, ÏóÜÏúºÎ©¥ HTML ÏãúÏûëÏóê Î∂ôÏûÑ
                if (html.toLowerCase().includes('<head>')) {
                    html = html.replace(/<head>/i, '<head>\n' + faCDN);
                } else {
                    html = faCDN + html;
                }
            }

            doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            iframe.onload = function () {
                doc = iframe.contentDocument || iframe.contentWindow.document;
                injectEditorStyles();
                enableEditing();
                if (!isHistoryOp) {
                    selectedEl = null;
                    updateSidebarUI();
                    setTimeout(() => saveState(), 100);
                } else {
                    selectedEl = null;
                    updateSidebarUI();
                }
            };
        }

        function injectEditorStyles() {
            if (!doc) return;
            // ÎßåÏïΩ loadContent Îã®Í≥ÑÏóêÏÑú Ï£ºÏûÖÎêòÏßÄ ÏïäÏïòÏùÑ Í≤ΩÏö∞Î•º ÎåÄÎπÑÌïú Î∞±ÏóÖ (ÏïàÏ†ïÏÑ±)
            if (!doc.querySelector('link[href*="font-awesome"]')) {
                const faLink = doc.createElement('link');
                faLink.rel = 'stylesheet';
                faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';
                // HeadÍ∞Ä ÏóÜÏúºÎ©¥ BodyÏóêÎùºÎèÑ Î∂ôÏûÑ
                (doc.head || doc.body).appendChild(faLink);
            }

            if (doc.getElementById('visual-editor-style')) return;

            const style = doc.createElement('style');
            style.id = 'visual-editor-style';
            style.innerHTML = `
                .ve-hover:hover { outline: 2px dashed #60a5fa !important; cursor: pointer; opacity: 0.95; }
                .ve-selected { outline: 2px solid #2563eb !important; outline-offset: -2px; z-index: 9999; box-shadow: 0 0 0 4px rgba(37,99,235,0.2); }
                a { pointer-events: none; }
                *:empty:not(img):not(br)::before { content: 'Empty Box'; color: #ccc; font-size: 10px; display: block; background: #f8f8f8; padding: 2px; }
            `;
            doc.head.appendChild(style);
        }

        function enableEditing() {
            const allElements = doc.body.getElementsByTagName('*');
            const skipTags = ['SCRIPT', 'STYLE', 'LINK', 'META', 'TITLE', 'BR', 'HR'];

            for (let el of allElements) {
                if (skipTags.includes(el.tagName)) continue;

                el.classList.add('ve-hover');

                if (el.tagName !== 'IMG') {
                    el.contentEditable = "true";
                    el.addEventListener('blur', () => saveState());
                    el.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                        doc.execCommand("insertText", false, text);
                    });
                }

                el.onclick = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectElement(el);
                };
            }

            doc.body.onclick = function (e) {
                if (e.target === doc.body) selectElement(doc.body);
            }
        }

        // --- Selection & UI Sync ---
        function selectElement(el) {
            if (selectedEl) selectedEl.classList.remove('ve-selected');
            selectedEl = el;
            selectedEl.classList.add('ve-selected');
            updateSidebarUI();
        }

        function selectParent() {
            if (selectedEl && selectedEl.parentElement && selectedEl.parentElement !== doc.documentElement) {
                selectElement(selectedEl.parentElement);
            }
        }

        function deselectAll(e) {
            if (e.target.id === 'editor-canvas') {
                if (selectedEl) selectedEl.classList.remove('ve-selected');
                selectedEl = null;
                updateSidebarUI();
            }
        }

        function updateSidebarUI() {
            const display = document.getElementById('selected-tag-display');
            const flexControls = document.getElementById('flex-controls');
            const imgControls = document.getElementById('img-control-group');

            if (!selectedEl) {
                display.innerText = "none";
                flexControls.classList.add('hidden');
                imgControls.style.display = 'none';
                return;
            }

            // 1. Tag Info
            let tagName = selectedEl.tagName.toLowerCase();
            if (selectedEl.id) tagName += `#${selectedEl.id}`;
            display.innerText = `<${tagName}>`;

            // Computed Style
            const s = window.getComputedStyle(selectedEl);
            const styleRaw = selectedEl.style; // Inline style Ïö∞ÏÑ† ÌôïÏù∏

            // 2. Typography
            setInputValue('input-font-family', getFontFamilyValue(s.fontFamily));
            setInputValue('input-color', rgbToHex(s.color));
            document.getElementById('text-color-val').innerText = rgbToHex(s.color);
            setInputValue('input-font-size', parseInt(s.fontSize) || '');
            setInputValue('input-line-height', s.lineHeight === 'normal' ? '' : parseFloat(s.lineHeight));

            // Text Align Buttons Active State
            updateBtnGroup('textAlign', s.textAlign);
            updateBtnToggle('fontWeight', s.fontWeight, ['bold', '700']);
            updateBtnToggle('fontStyle', s.fontStyle, ['italic']);
            updateBtnToggle('textDecoration', s.textDecorationLine, ['underline']);

            // 3. Layout
            setInputValue('input-display', s.display);
            if (s.display === 'flex' || s.display === 'inline-flex') {
                flexControls.classList.remove('hidden');
                setInputValue('input-justify', s.justifyContent);
                setInputValue('input-align', s.alignItems);
                setInputValue('input-gap', styleRaw.gap || s.gap); // GapÏùÄ computedÍ∞Ä 0pxÎ°ú ÎÇòÏò¨ ÎïåÍ∞Ä ÎßéÏïÑ inline Ïö∞ÏÑ†
            } else {
                flexControls.classList.add('hidden');
            }

            setInputValue('input-padding', styleRaw.padding || s.padding);
            setInputValue('input-margin', styleRaw.margin || s.margin);
            setInputValue('input-width', styleRaw.width || (s.width !== 'auto' ? s.width : ''));
            setInputValue('input-height', styleRaw.height || (s.height !== 'auto' ? s.height : ''));

            // 4. Decoration
            let bgCol = s.backgroundColor;
            if (bgCol === 'rgba(0, 0, 0, 0)' || !bgCol) bgCol = 'transparent';
            setInputValue('input-bg-color', rgbToHex(bgCol));
            document.getElementById('bg-color-val').innerText = rgbToHex(bgCol);

            // Radius
            const rad = parseInt(s.borderRadius) || 0;
            document.getElementById('input-radius').value = rad;
            document.getElementById('radius-val').innerText = rad + 'px';

            // Border (Simple parsing)
            // ÌÖåÎëêÎ¶¨Îäî ÏÉÅÌïòÏ¢åÏö∞ Îã§Î•º Ïàò ÏûàÏúºÎÇò, ÏóêÎîîÌÑ∞ÏóêÏÑ† Ìé∏ÏùòÏÉÅ border-top Í∏∞Ï§ÄÏúºÎ°ú ÌëúÏãú
            const bw = parseInt(s.borderTopWidth) || 0;
            setInputValue('input-border-width', bw);
            setInputValue('input-border-style', s.borderTopStyle === 'none' ? 'none' : s.borderTopStyle);
            setInputValue('input-border-color', rgbToHex(s.borderTopColor));

            // 5. Advanced & Img
            if (selectedEl.tagName === 'IMG') {
                imgControls.style.display = 'block';
                setInputValue('input-src', selectedEl.getAttribute('src'));
            } else {
                imgControls.style.display = 'none';
            }

            setInputValue('input-classes', selectedEl.className.replace('ve-hover', '').replace('ve-selected', '').trim());
            setInputValue('input-html', selectedEl.outerHTML);
        }

        // Helpers
        function setInputValue(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val;
        }

        function getFontFamilyValue(val) {
            if (!val) return "";
            if (val.includes('Jua')) return "'Jua', sans-serif";
            if (val.includes('Comfortaa')) return "'Comfortaa', cursive";
            if (val.includes('sans-serif')) return "sans-serif";
            if (val.includes('serif')) return "serif";
            if (val.includes('monospace')) return "monospace";
            return "";
        }

        function updateBtnGroup(prop, val) {
            // align-left, align-center ...
            ['left', 'center', 'right', 'justify'].forEach(k => {
                const btn = document.getElementById(`btn-align-${k}`);
                if (btn) {
                    if (val === k) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
        }

        function updateBtnToggle(prop, val, matches) {
            // bold, italic, underline
            let btnId = '';
            if (prop === 'fontWeight') btnId = 'btn-bold';
            if (prop === 'fontStyle') btnId = 'btn-italic';
            if (prop === 'textDecoration') btnId = 'btn-underline';

            const btn = document.getElementById(btnId);
            if (btn) {
                // valÏù¥ 'bold' ÌòπÏùÄ '700' Îì±Ïù¥Î©¥ active
                const isActive = matches.some(m => String(val).includes(m));
                if (isActive) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        }

        function rgbToHex(rgb) {
            if (!rgb || rgb === 'transparent' || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
            if (rgb.startsWith('#')) return rgb;
            const rgbValues = rgb.match(/\d+/g);
            if (!rgbValues) return '#000000';
            return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1);
        }

        // --- Apply Logic ---
        function applyStyle(prop, value) {
            if (!selectedEl) return;
            selectedEl.style[prop] = value;
            if (prop === 'backgroundColor') document.getElementById('bg-color-val').innerText = rgbToHex(value);
            if (prop === 'color') document.getElementById('text-color-val').innerText = rgbToHex(value);

            // ÎßåÏïΩ displayÍ∞Ä Î∞îÎÄåÎ©¥ ÏÇ¨Ïù¥ÎìúÎ∞î UI Í∞±Ïã† ÌïÑÏöî (Flex ÏòµÏÖò ÎÖ∏Ï∂ú Îì±)
            if (prop === 'display') updateSidebarUI();

            saveState();
        }

        function toggleStyle(prop, valOn, valOff) {
            if (!selectedEl) return;
            const current = window.getComputedStyle(selectedEl)[prop];
            // ÎåÄÎûµÏ†ÅÏù∏ ÌÜ†Í∏Ä Î°úÏßÅ
            const isSet = String(current).includes(valOn) || (valOn === 'bold' && current === '700');
            selectedEl.style[prop] = isSet ? valOff : valOn;
            updateSidebarUI();
            saveState();
        }

        function updateBorder() {
            if (!selectedEl) return;
            const w = document.getElementById('input-border-width').value;
            const s = document.getElementById('input-border-style').value;
            const c = document.getElementById('input-border-color').value;

            if (s === 'none') {
                selectedEl.style.border = 'none';
            } else {
                const width = w ? w + 'px' : '1px';
                selectedEl.style.border = `${width} ${s} ${c}`;
            }
            saveState();
        }

        function applyAttribute(attr, value) {
            if (!selectedEl) return;
            selectedEl.setAttribute(attr, value);
            saveState();
        }

        function applyClasses(value) {
            if (!selectedEl) return;
            const internalClasses = ['ve-hover', 've-selected'];
            selectedEl.className = value + ' ' + internalClasses.join(' ');
            saveState();
        }

        function toggleHtmlEdit() {
            const area = document.getElementById('input-html');
            area.classList.toggle('hidden');
        }

        function applyOuterHTML(value) {
            if (!selectedEl) return;
            try {
                // ÏÑ†ÌÉù ÏöîÏÜå ÍµêÏ≤¥ Î°úÏßÅ
                // 1. ÏûÑÏãú divÏóê ÎÑ£Ïñ¥ ÌååÏã±
                const temp = doc.createElement('div');
                temp.innerHTML = value;
                const newEl = temp.firstElementChild;
                if (!newEl) return;

                // 2. ÍµêÏ≤¥
                selectedEl.replaceWith(newEl);

                // 3. Ïû¨ÏÑ§Ï†ï
                selectedEl = newEl; // Ìè¨Ïª§Ïä§ Ïú†ÏßÄ ÎÖ∏Î†•
                injectEditorStyles(); // ÏÉà ÏöîÏÜåÏóê Ïä§ÌÉÄÏùº/Ïù¥Î≤§Ìä∏ ÏóÜÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú Ïû¨Ï£ºÏûÖ
                enableEditing();

                selectElement(selectedEl); // UI Í∞±Ïã†
                saveState();
            } catch (e) {
                alert("HTML Ïò§Î•ò");
            }
        }

        // --- Actions ---
        function deleteSelected() {
            if (!selectedEl) return;
            if (confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                selectedEl.remove();
                selectedEl = null;
                updateSidebarUI();
                saveState();
            }
        }

        function cloneSelected() {
            if (!selectedEl) return;
            const clone = selectedEl.cloneNode(true);
            clone.classList.remove('ve-selected');
            selectedEl.insertAdjacentElement('afterend', clone);
            saveState();
            enableEditing();
        }

        document.getElementById('img-changer').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file && selectedEl && selectedEl.tagName === 'IMG') {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    selectedEl.src = evt.target.result;
                    updateSidebarUI();
                    saveState();
                };
                reader.readAsDataURL(file);
            }
            this.value = '';
        });

        function saveHTML() {
            if (!doc) return;
            const style = doc.getElementById('visual-editor-style');
            if (style) style.remove();
            const selected = doc.querySelector('.ve-selected');
            if (selected) selected.classList.remove('ve-selected');
            const hovers = doc.querySelectorAll('.ve-hover');
            hovers.forEach(el => el.classList.remove('ve-hover'));
            const editables = doc.querySelectorAll('[contenteditable]');
            editables.forEach(el => el.removeAttribute('contenteditable'));

            const htmlContent = doc.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "edited_page_v02.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            injectEditorStyles();
            enableEditing();
            if (selected) selected.classList.add('ve-selected');
        }

        function setDevice(type) {
            iframe.className = type;
        }

        window.onload = function () {
            // Îç∞Î™® Î°úÎìú (Jelly Mix ÌÖåÎßà ÎßõÎ≥¥Í∏∞)
            const demoHTML = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body{display:flex;justify-content:center;align-items:center;height:100vh;font-family:'Jua',sans-serif;background:#fff0f6;margin:0;} 
        .card{background:white;padding:50px;border-radius:40px;box-shadow:0 20px 50px rgba(255, 118, 117, 0.2);text-align:center;width:400px;border:8px solid #fff;}
        h1{color:#a29bfe;font-size:48px;margin:0 0 20px 0;text-shadow:2px 2px 0 #dfe6e9;}
        p{color:#636e72;font-size:20px;line-height:1.6;}
        .btn{background:#74b9ff;color:white;padding:15px 30px;font-size:24px;border-radius:50px;border:none;margin-top:30px;display:inline-block;box-shadow:0 10px 20px rgba(116, 185, 255, 0.4);}
    </style>
</head>
<body>
    <div class="card">
        <h1>Jelly Editor</h1>
        <p>ÏôºÏ™Ω [Ïó¥Í∏∞] Î≤ÑÌäºÏúºÎ°ú<br><strong>'Ï†§Î¶¨ÎØπÏä§ Í∏∞ÌöçÏÑú.html'</strong>ÏùÑ Î∂àÎü¨ÏôÄ<br>ÏàòÏ†ïÌï¥Î≥¥ÏÑ∏Ïöî!</p>
        <button class="btn">ÏãúÏûëÌïòÍ∏∞</button>
    </div>
</body>
</html>`;
            loadContent(demoHTML);
        }
    </script>
</body>

</html>